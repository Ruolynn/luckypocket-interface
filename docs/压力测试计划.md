# 压力测试计划

## 📅 测试时间表

### 阶段 1: 基础准备（当前 - 1周内）

**目标**: 准备测试环境和工具

**任务**:
- [x] 创建压力测试脚本
- [ ] 设置独立的测试环境
- [ ] 配置监控和日志收集
- [ ] 准备测试数据和测试钱包
- [ ] 安装压力测试工具（k6）

**预计时间**: 1-2 天

### 阶段 2: 基础 API 压力测试（1-2周后）

**目标**: 测试核心 API 端点的性能

**测试范围**:
- 健康检查端点
- 礼物查询端点
- 礼物列表端点
- 统计信息端点
- 排行榜端点

**成功标准**:
- P95 响应时间 < 500ms
- P99 响应时间 < 1s
- 错误率 < 1%
- 支持 100+ 并发用户

**预计时间**: 2-3 天

### 阶段 3: 业务场景压力测试（2-3周后）

**目标**: 模拟真实业务场景

**测试场景**:
1. **高并发创建礼物**
   - 50+ 并发用户同时创建
   - 测试数据库写入性能
   - 测试链上交易处理能力

2. **高并发领取**
   - 50+ 并发用户同时领取同一礼物
   - 测试分布式锁性能
   - 测试幂等性处理

3. **Frame 领取压力测试**
   - 模拟 100+ Farcaster 用户同时领取
   - 测试 FID 解析性能
   - 测试代理领取性能

4. **实时通信压力测试**
   - 500+ 并发 WebSocket 连接
   - 测试 Socket.IO 性能
   - 测试消息广播性能

**成功标准**:
- 所有业务场景正常运行
- 无数据丢失或损坏
- 系统资源使用合理

**预计时间**: 3-5 天

### 阶段 4: 极限压力测试（3-4周后）

**目标**: 找到系统瓶颈和极限

**测试场景**:
1. **峰值流量测试**
   - 模拟流量峰值（1000+ 并发用户）
   - 测试系统降级策略
   - 测试熔断机制

2. **长时间运行测试**
   - 24 小时持续运行
   - 测试内存泄漏
   - 测试连接池管理

3. **故障恢复测试**
   - 数据库故障恢复
   - Redis 故障恢复
   - RPC 节点故障恢复

**预计时间**: 2-3 天

## 🎯 当前项目状态评估

### 可以立即开始的测试

1. **API 只读端点压力测试** ✅
   - 健康检查
   - 礼物查询
   - 礼物列表
   - 统计信息
   - 排行榜
   - **不需要链上交互，可以立即开始**

2. **数据库查询性能测试** ✅
   - 并发查询测试
   - 索引优化验证
   - **可以立即开始**

### 需要准备环境的测试

1. **业务场景压力测试** ⚠️
   - 需要测试钱包和测试代币
   - 需要独立的测试数据库
   - **预计 1-2 周后可以开始**

2. **完整压力测试** ⚠️
   - 需要完整的测试环境
   - 需要监控和日志系统
   - **预计 2-3 周后可以开始**

## 📊 测试指标目标

### API 性能目标
- **响应时间**:
  - P50: < 100ms
  - P95: < 500ms
  - P99: < 1s
- **吞吐量**: > 1000 请求/秒
- **错误率**: < 0.1%
- **并发用户**: 支持 500+ 并发

### 数据库性能目标
- **查询响应时间**: < 50ms (P95)
- **写入性能**: > 100 事务/秒
- **连接池使用率**: < 70%
- **慢查询**: 0

### Redis 性能目标
- **命令响应时间**: < 1ms (P95)
- **缓存命中率**: > 95%
- **内存使用率**: < 70%

### 系统资源目标
- **CPU 使用率**: < 60% (正常负载)
- **内存使用率**: < 70%
- **无内存泄漏**

## 🛠️ 测试工具和脚本

### 已创建的工具

1. **k6 API 压力测试脚本** (`scripts/load-test/k6-api-test.js`)
   - 测试核心 API 端点
   - 可配置并发用户数
   - 自动生成报告

2. **k6 WebSocket 压力测试脚本** (`scripts/load-test/k6-websocket-test.js`)
   - 测试 Socket.IO 连接
   - 测试消息订阅
   - 测试连接稳定性

3. **压力测试启动脚本** (`scripts/load-test/load-test.sh`)
   - 一键启动测试
   - 自动检查环境
   - 支持多种测试类型

### 使用方式

```bash
# 安装 k6
# macOS: brew install k6
# Linux: 参考 https://k6.io/docs/getting-started/installation/

# 运行压力测试
./scripts/load-test/load-test.sh

# 或直接运行 k6
k6 run --env API_URL=http://localhost:3001 scripts/load-test/k6-api-test.js
```

## 📋 测试检查清单

### 测试前检查
- [ ] API 服务运行正常
- [ ] 数据库连接正常
- [ ] Redis 连接正常
- [ ] 监控系统已配置
- [ ] 测试数据已准备
- [ ] 测试工具已安装

### 测试中监控
- [ ] API 响应时间
- [ ] 错误率
- [ ] 数据库性能
- [ ] Redis 性能
- [ ] 系统资源使用
- [ ] 日志错误

### 测试后分析
- [ ] 性能指标分析
- [ ] 瓶颈识别
- [ ] 优化建议
- [ ] 测试报告生成

## 🚀 建议的测试时间线

### 立即开始（今天）
1. **运行基础 API 压力测试**
   ```bash
   ./scripts/load-test/load-test.sh
   # 选择选项 1: API 压力测试
   ```

2. **分析结果并优化**
   - 识别慢查询
   - 优化数据库索引
   - 优化 API 响应

### 1 周内
1. **完善测试环境**
   - 设置独立的测试数据库
   - 准备测试钱包和代币
   - 配置监控系统

2. **运行 WebSocket 压力测试**
   ```bash
   ./scripts/load-test/load-test.sh
   # 选择选项 2: WebSocket 压力测试
   ```

### 2-3 周内
1. **运行完整业务场景测试**
   - 创建礼物压力测试
   - 领取礼物压力测试
   - Frame 领取压力测试

2. **运行极限压力测试**
   - 峰值流量测试
   - 长时间运行测试
   - 故障恢复测试

## 📈 持续监控

压力测试不是一次性的，应该：

1. **每次重大更新后**
   - 运行回归压力测试
   - 对比性能变化

2. **定期测试**（每月）
   - 运行完整测试套件
   - 分析性能趋势

3. **生产环境监控**
   - 实时监控性能指标
   - 设置告警阈值
   - 根据监控数据优化

## 🎯 总结

**项目完成度**: ~85%

**可以开始压力测试的时间**:
- **基础 API 测试**: ✅ 现在就可以开始
- **业务场景测试**: ⚠️ 1-2 周后（需要准备测试环境）
- **完整压力测试**: ⚠️ 2-3 周后（所有功能稳定后）

**建议**:
1. 立即开始基础 API 压力测试，识别和优化性能瓶颈
2. 同时准备测试环境，为业务场景测试做准备
3. 在功能稳定后，进行完整的压力测试

