# ğŸ§© çº¢åŒ… dApp æ¨¡å—åŒ–æŠ€æœ¯è½åœ°æ–¹æ¡ˆï¼ˆæ¥å£ä¸ä¼ªä»£ç ï¼‰

æœ¬æ–‡é¢å‘ç ”å‘è½åœ°ï¼ŒæŒ‰åŠŸèƒ½å°æ¨¡å—ç»™å‡ºï¼šç›®æ ‡ã€æŠ€æœ¯ä¾èµ–ã€æ¥å£å®šä¹‰ï¼ˆREST/WS/åˆçº¦/Frameï¼‰ã€æ•°æ®ç»“æ„ã€ä¼ªä»£ç ã€è¾¹ç•Œä¸é£æ§ã€éªŒæ”¶æµ‹è¯•è¦ç‚¹ã€‚é»˜è®¤é“¾ä¸º Baseï¼Œä¸»ä»£å¸ USDC(6 decimals)ã€‚

---

## 0. ç»Ÿä¸€çº¦å®š
- **æ ‡è¯†**ï¼š`packetId` ä½¿ç”¨åˆçº¦ä¾§ bytes32 çš„ 0x å‰ç¼€åå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼›`userId` ä¸ºåç«¯ `User.id`ï¼ˆcuidï¼‰ã€‚
- **é‡‘é¢**ï¼šé“¾ä¸Š BigIntï¼Œé“¾ä¸‹ä»¥å­—ç¬¦ä¸²å­˜å‚¨ï¼ˆæœ€å°å•ä½ï¼‰ï¼Œå‰ç«¯æ ¼å¼åŒ–æ˜¾ç¤ºã€‚
- **é‰´æƒ**ï¼š
  - Webï¼šJWT(`Authorization: Bearer <token>`)ï¼Œç­¾å‘å¯¹è±¡ä¸º `User.id`ã€‚
  - Frameï¼šFarcaster Fid è§£æ â†’ ç»‘å®š Addressï¼ˆåªè¯»ï¼‰â†’ åç«¯ä»£ç†äº¤æ˜“ã€‚
- **å¹‚ç­‰**ï¼šæ‰€æœ‰å†™æ¥å£è¦æ±‚ `Idempotency-Key`ï¼ˆUUIDï¼‰ã€‚æœåŠ¡ç«¯ä¿å­˜ 24hã€‚
- **é€Ÿç‡é™åˆ¶**ï¼šå…³é”®è·¯å¾„å¦‚ `/packets/claim`ã€`/frames/claim`ï¼ŒIP/Address/User å¤šç»´é™æµã€‚

---

## 1. æ™ºèƒ½åˆçº¦æ¨¡å—ï¼ˆRedPacket.solï¼‰

### 1.1 ç›®æ ‡
- æ”¯æŒå›ºå®š/éšæœºæ‹¼æ‰‹æ°”çº¢åŒ…ã€è¿‡æœŸé€€æ¬¾ã€äº‹ä»¶ä¸ŠæŠ¥ï¼›å¹³å°æ‰‹ç»­è´¹æ‰£é™¤ï¼›VRF éšæœºã€‚

### 1.2 ä¾èµ–
- Solidity 0.8.24 / Foundry
- OpenZeppelin ERC20/SafeERC20/ReentrancyGuard/Ownable
- Chainlink VRF v2.5ï¼ˆBaseï¼‰

### 1.3 å…³é”®æ¥å£ï¼ˆABI æ‘˜è¦ï¼‰
- `createPacket(address token, uint256 totalAmount, uint32 count, bool isRandom, uint256 duration, bytes32 salt) returns (bytes32 packetId)`
- `claimPacket(bytes32 packetId) returns (uint256 amount)`
- `refund(bytes32 packetId)`
- `getPacketInfo(bytes32) view returns (...)`
- äº‹ä»¶ï¼š`PacketCreated`, `PacketClaimed`, `PacketRefunded`ï¼Œéšæœºï¼š`RandomnessRequested`, `RandomnessFulfilled`

### 1.4 ä¼ªä»£ç ï¼ˆå…³é”®è·¯å¾„ï¼‰
```pseudo
createPacket(token, totalAmount, count, isRandom, duration, salt):
  require MIN_AMOUNT <= totalAmount <= MAX_AMOUNT
  require 0 < count <= MAX_COUNT
  require 0 < duration <= MAX_DURATION
  fee = totalAmount * platformFee / 10000
  net = totalAmount - fee
  packetId = keccak256(msg.sender, block.timestamp, salt)
  transferFrom(msg.sender, this, totalAmount)
  if fee > 0: transfer(feeCollector, fee)
  packets[packetId] = Packet{ ... net, count, expireTime, ... }
  if isRandom: requestRandomness(packetId)
  emit PacketCreated(...)
  return packetId

claimPacket(packetId):
  p = packets[packetId]
  require exists && now <= p.expireTime && p.remainingCount > 0
  require claims[packetId][msg.sender] == 0
  amount = p.isRandom ? calcRandomAmount(packetId) : p.remainingAmount / p.remainingCount
  p.remainingAmount -= amount; p.remainingCount -= 1
  claims[packetId][msg.sender] = { claimer: msg.sender, amount, ts }
  transfer(p.token, msg.sender, amount)
  emit PacketClaimed(packetId, msg.sender, amount, p.remainingCount)
  return amount

refund(packetId):
  require msg.sender == p.creator && now > p.expireTime && !p.refunded
  refundAmount = p.remainingAmount
  if refundAmount > 0:
    p.remainingAmount = 0; p.refunded = true
    transfer(p.token, p.creator, refundAmount)
    emit PacketRefunded(packetId, p.creator, refundAmount)
```

### 1.5 è¾¹ç•Œä¸é£æ§
- VRF æœªå°±ç»ª â†’ `RandomnessNotReady`ï¼Œå‰ç«¯ä¸åç«¯éœ€é‡è¯•/å¼•å¯¼ã€‚
- æœ€åä¸€ä»½éšæœºé¢†å–=å…¨éƒ¨å‰©ä½™ï¼›æœ€å°ä»½é¢ä¿æŠ¤ `minAmount`ã€‚
- å¹³å°è´¹ä¸Šé™ 5%ï¼›Owner å¯å˜æ›´è´¹ç‡/æ”¶æ¬¾äººã€‚

### 1.6 éªŒæ”¶è¦ç‚¹
- å•å…ƒæµ‹è¯•ï¼šé‡å¤é¢†å–å¤±è´¥ã€è¿‡æœŸé€€æ¬¾æ­£ç¡®ã€éšæœºæ€»å’Œå®ˆæ’ã€æ‰‹ç»­è´¹æ‰£é™¤æ­£ç¡®ã€‚

---

## 2. è´¦æˆ·ä¸ AA ä»£ä»˜æ¨¡å—

### 2.1 ç›®æ ‡
- æ”¯æŒ Privy åµŒå…¥å¼é’±åŒ…ç™»å½•ä¸åˆ›å»ºï¼›å…³é”®äº¤äº’å¯ä»£ä»˜ï¼ˆé™é¢/åå•/é€Ÿç‡ï¼‰ã€‚

### 2.2 ä¾èµ–
- Privy SDKï¼ˆå‰ç«¯ï¼‰ã€æœåŠ¡ç«¯æ ¡éªŒ Webhookï¼ˆå¯é€‰ï¼‰
- Paymasterï¼ˆè‡ªå»º/ç¬¬ä¸‰æ–¹ï¼‰ï¼Œç­–ç•¥é™é¢è¡¨

### 2.3 é…ç½®ä¸æ•°æ®
- ç¯å¢ƒå˜é‡ï¼š`PAYMASTER_PRIVATE_KEY`, `PAYMASTER_MAX_DAILY_USD`, `PAYMASTER_WHITELIST`
- è¡¨ï¼š`GasPolicy(userId, dailyLimit, usedAmount, updatedAt, flags)`

### 2.4 ä¼ªä»£ç 
```pseudo
shouldSponsor(userId, action):
  policy = GasPolicy.find(userId)
  if policy.flags.contains('blocked'): return false
  if action not in ALLOWLIST_ACTIONS: return false
  usdCost = estimateActionUsd(action)
  if policy.usedAmount + usdCost > policy.dailyLimit: return false
  return true

sponsorTx(rawTx):
  signed = paymaster.signSponsored(rawTx)
  send(signed)
  update GasPolicy.usedAmount += estimateUsd(rawTx)
```

### 2.5 é£æ§
- ä»…ç™½åå•å‡½æ•°ä¸é¢åº¦ä»£ä»˜ï¼›é˜ˆå€¼ä¸é»‘åå•ï¼›å¼‚å¸¸å›æ»šä¸æŠ¥è­¦ï¼ˆSentryï¼‰ã€‚

---

## 3. åç«¯ APIï¼ˆExpressï¼‰

### 3.1 å‘çº¢åŒ…è®°å½•
- `POST /api/packets/create`
  - Header: `Authorization`, `Idempotency-Key`
  - Body: `{ txHash, packetId, message?, amount, count, isRandom }`
  - é€»è¾‘ï¼šæ ¡éªŒé“¾ä¸Šäº¤æ˜“æˆåŠŸ â†’ è®°å½• DB â†’ é€šçŸ¥ç²‰ä¸ â†’ è¿”å›è®°å½•
  - ä¼ªä»£ç ï¼š
```pseudo
createPacket(req):
  require auth
  ensureIdempotency(req.idemKey)
  assert verifyTxOnChain(txHash)
  upsert Packet by packetId { txHash, meta, creatorId }
  notifyFollowers(creatorId, packet.id)
  return packet
```

### 3.2 é¢†å–ï¼ˆä»£ç†ï¼‰
- `POST /api/packets/claim`
  - Header: `Authorization`, `Idempotency-Key`
  - Body: `{ packetId }`
  - é€»è¾‘ï¼šæ ¡éªŒå¯é¢†å– â†’ è°ƒç”¨åˆçº¦ â†’ è®°å½• Claim â†’ æ¨é€ WS
```pseudo
claimPacket(req):
  require auth
  ensureIdempotency
  assert canClaim(packetId, userId)
  tx = contract.claimPacket(packetId) by user/address
  amount = parseEvent(tx, PacketClaimed)
  save Claim(userId, packetId, amount, txHash)
  emitWS(packetId, 'packet:claimed', { userId, amount })
  return { amount, txHash }
```

### 3.3 æŸ¥è¯¢
- `GET /api/packets/:packetId`
- `GET /api/packets/:packetId/claims?page&limit`
- `POST /api/packets/:packetId/refund`

---

## 4. Frames é›†æˆä¸é¢†å–ä»£ç†

### 4.1 ç›®æ ‡
- åœ¨ Warpcast å†…å®Œæˆâ€œæŸ¥çœ‹â†’é¢†å–â†’ç»“æœå±•ç¤ºâ€ï¼Œåç«¯ä»£ç†å‘èµ·é“¾ä¸Šäº¤æ˜“ï¼›ä¿è¯é‰´æƒã€å¹‚ç­‰ä¸å¹¶å‘å®‰å…¨ã€‚

### 4.2 ä¾èµ–
- Frogï¼ˆNext.js Routeï¼‰
- Farcaster Hub APIï¼ˆFidâ†’Addressï¼‰
- Redis/KV ç¼“å­˜ Frame çŠ¶æ€

### 4.3 æ¥å£
- `GET/POST /api/frame/:packetId`ï¼ˆæ˜¾ç¤ºï¼‰
- `POST /api/frame/claim/:packetId`ï¼ˆé¢†å–åŠ¨ä½œï¼‰

### 4.4 ä¼ªä»£ç 
```pseudo
frameShow(packetId):
  packet = cache.getOrLoad(packetId, readContract)
  return image + intents([ Claim, Details, LinkToDapp ])

frameClaim(packetId, fid):
  ensureIdempotency(fid+packetId)
  addr = getUserAddressFromFid(fid)
  if hasClaimed(packetId, addr): return already screen
  // ç»‘å®šï¼šè‹¥ addr æœªç»‘å®šåˆ° Userï¼Œåˆ™åˆ›å»º/ç»‘å®šå½±å­ç”¨æˆ·
  user = findOrCreateUserByAddress(addr)
  if !canClaim(packetId, user.id): return error screen
  result = backendClaimProxy(packetId, user.id)
  return success screen(amount)

backendClaimProxy(packetId, userId):
  lock(packetId, userId)  // é˜²å¹¶å‘
  try:
    return POST /api/packets/claim
  finally:
    unlock
```

### 4.5 é£æ§
- é’ˆå¯¹åŒä¸€ `fid` ä¸ `packetId` åŠ åˆ†å¸ƒå¼é”ï¼›å¤±è´¥é‡è¯•é€€é¿ã€‚

---

## 5. å¢é•¿æ¨¡å—

### 5.1 é‚€è¯·å¥–åŠ±
- ç›®æ ‡ï¼šç›´æ¥/äºŒçº§é‚€è¯·ç»“ç®—ï¼›é˜²åˆ·ã€‚
- APIï¼š
  - `POST /api/invite/accept { inviterCode }`
  - `GET /api/invite/stats`
- æ•°æ®ï¼š`Invitation(inviterId, inviteeId, rewardPaid)`
- ä¼ªä»£ç ï¼š
```pseudo
acceptInvite(inviteeId, inviterCode):
  inviter = findByCode(inviterCode)
  if inviter == invitee: reject
  if exists(inviterId, inviteeId): return ok
  create Invitation()
  maybeGrantWelcomeReward(inviteeId)

settleReferralRewards(daily job):
  for each invitation:
    if invitee reached criteria (e.g., first claim or first send >= X):
      credit inviter small commission
```
- é£æ§ï¼šè®¾å¤‡/IP æŒ‡çº¹å»é‡ï¼›è¾¾åˆ°é˜ˆå€¼æ‰å‘æ”¾ã€‚

### 5.2 åŠ©åŠ›æŠ¢çº¢åŒ…
- ç›®æ ‡ï¼šè¢«é‚€è¯·è€…å®Œæˆæ³¨å†Œ/é¦–äº¤äº’åï¼Œé‚€è¯·è€…è¡¥é¢†å‰©ä½™é‡‘é¢ã€‚
- åˆçº¦ä¾§å¯é€‰ï¼šé“¾ä¸Šæ ¡éªŒ Inviteï¼ˆV2ï¼‰ï¼›MVP å…ˆé“¾ä¸‹ç»“ç®—è¡¥è´´ã€‚
- APIï¼š
  - `POST /api/assist/request { packetId }`
  - `POST /api/assist/complete { packetId, inviteeId }`
- ä¼ªä»£ç ï¼š
```pseudo
assistRequest(userId, packetId):
  create AssistTask(packetId, owner=userId, need=3)

assistComplete(packetId, inviteeId):
  mark progress; if reached need -> grant bonus(off-chain or on-chain)
```

### 5.3 æ’è¡Œæ¦œ
- å£å¾„ï¼šæ‰‹æ°”æ¦œ(å‘¨å•æ¬¡æœ€å¤§é‡‘é¢)ã€æ…·æ…¨æ¦œ(æœˆåº¦å‘å‡ºæ€»é¢)ã€æ´»è·ƒæ¦œ(å‚ä¸æ¬¡æ•°)
- APIï¼š`GET /api/leaderboard?type=luck|generous|active&range=week|month|realtime`
- ä¼ªä»£ç ï¼š
```pseudo
rebuildLeaderboard(range):
  aggregate Claims/Packets into Redis sorted sets
  expose top N with ranks
```

### 5.4 æˆå°±ç³»ç»Ÿ
- ä¾‹ï¼šé¦–æ¬¡å‘çº¢åŒ…ã€è¿ç»­ç™»å½•ã€æ‰‹æ°”æœ€ä½³x10ã€é‚€è¯·x10
- APIï¼š`GET /api/achievements`, `POST /api/achievements/check`ï¼ˆæœåŠ¡ç«¯å¼‚æ­¥è§¦å‘ï¼‰
- ä¼ªä»£ç ï¼š
```pseudo
evaluateAchievements(userId, event):
  rules = RULES[event]
  for r in rules: if r.condition(user): grantBadge(r)
```

### 5.5 çº¢åŒ…é›¨
- å®šæ—¶ä»»åŠ¡ï¼šæ¯æ—¥å›ºå®šæ—¶æ®µåˆ›å»ºå®˜æ–¹çº¢åŒ…å¹¶æ¨é€å€’è®¡æ—¶ã€‚
- ä¼ªä»£ç ï¼š
```pseudo
cron(12:00, 18:00, 22:00):
  create official Packet via admin wallet
  broadcast schedule via WS/Email/Telegram(optional)
```

### 5.6 æ¨é€é€šçŸ¥
- WebSocket ä¸ºä¸»ï¼Œé‚®ä»¶/Telegram å¯é€‰ã€‚é¢‘æ§ï¼šæ¯æ—¥ â‰¤ 3ã€‚
- äº‹ä»¶ï¼š`packet_created`, `packet_claimed`, `rank_update`ã€‚

---

## 6. åå¥³å·«ä¸é£æ§
- å¤šç»´é™æµï¼šIPã€Addressã€Userã€Fidã€è®¾å¤‡æŒ‡çº¹ã€‚
- é»‘ç™½åå•ã€å¯ç–‘åˆ†å€¼ï¼ˆé˜ˆå€¼è§¦å‘éªŒè¯ç /äººå·¥å¤æ ¸ï¼‰ã€‚
- é¢†å–å¹¶å‘é”ã€å¹‚ç­‰é”®å¼ºåˆ¶ã€‚
- é‚€è¯·æœ‰æ•ˆæ€§æ¡ä»¶ï¼ˆé¦–ç¬”çœŸå®äº¤äº’ï¼‰ã€‚

---

## 7. è´¹ç”¨ä¸ç»“ç®—
- å¹³å°æ‰‹ç»­è´¹ï¼šé“¾ä¸Šæ‰£é™¤ï¼ˆä¸Šé™ 5%ï¼‰ï¼Œæ´»åŠ¨æœŸæ”¯æŒç™½åå• 0%ï¼ˆé“¾ä¸Š/é“¾ä¸‹è¡¥è´´äºŒé€‰ä¸€ï¼‰ã€‚
- é‚€è¯·ä½£é‡‘ï¼šMVP é“¾ä¸‹å…¥è´¦ï¼ˆä½™é¢è¡¨ï¼‰ï¼Œè¾¾é—¨æ§›å¯æå–ï¼›V2 è€ƒè™‘é“¾ä¸Šæ¸…ç»“ç®—ã€‚

---

## 8. æ•°æ®æ¨¡å‹ï¼ˆPrisma æ‘˜è¦ï¼‰
- `User(id, address, farcasterFid, ...)`
- `Packet(id, packetId, txHash, creatorId, token, totalAmount, count, isRandom, message, remainingAmount, remainingCount, expireTime, refunded)`
- `Claim(id, packetId, userId, amount, txHash, isBest, claimedAt)`
- `Invitation(id, inviterId, inviteeId, rewardPaid)`
- `Notification(id, userId, type, title, content, data, read)`
- `GasPolicy(userId, dailyLimit, usedAmount, flags)`

---

## 9. å®æ—¶ä¸ä»»åŠ¡
- WebSocket æˆ¿é—´ï¼š`user:<userId>`, `packet:<packetId>`ï¼›
- äº‹ä»¶ç›‘å¬ä»»åŠ¡ï¼šè¯»å– `PacketClaimed` æ—¥å¿— â†’ æ›´æ–° DB â†’ å¹¿æ’­ï¼›
- å®šæ—¶é‡å»ºæ’è¡Œæ¦œä¸æˆå°±è¯„ä¼°ï¼›
- å¤±è´¥é‡è¯•ä¸æ­»ä¿¡é˜Ÿåˆ—ï¼ˆBullï¼‰ã€‚

---

## 10. æµ‹è¯•ä¸ç›‘æ§
- åˆçº¦ï¼šFoundry å•æµ‹/è¦†ç›–ç‡ã€Fuzzã€Gas æŠ¥å‘Šï¼›
- åç«¯ï¼šJest/Supertestï¼›å‰ç«¯ï¼šVitest/RTLï¼›E2Eï¼šPlaywrightï¼›
- ç›‘æ§ï¼šSentryã€æ—¥å¿—ç»“æ„åŒ–ã€å…³é”®æŒ‡æ ‡ä»ªè¡¨ç›˜ï¼ˆK-Factorã€D1/D7/D30ï¼‰ã€‚

---

## 11. éƒ¨ç½²ä¸é…ç½®
- å‰ç«¯ï¼šVercelï¼›åç«¯ï¼šRailway/Dockerï¼›åˆçº¦ï¼šFoundry è„šæœ¬ï¼›
- ç¯å¢ƒå˜é‡å¯¹ç…§ï¼š`ALCHEMY_API_KEY`, `RED_PACKET_CONTRACT`, `JWT_SECRET`, `DATABASE_URL`, `REDIS_URL`, `PAYMASTER_*`, `FARCASTER_API_KEY`ï¼›
- CI/CDï¼šåˆ†æ”¯ä¿æŠ¤ã€é¢„è§ˆç¯å¢ƒã€è¿ç§»ä¸å›æ»šè®¡åˆ’ã€‚

---

## 12. éªŒæ”¶æ¸…å•ï¼ˆMVPï¼‰
- å‘/æŠ¢/é€€æ¬¾å…¨é“¾è·¯æˆåŠŸç‡ > 99%ï¼›
- Frame é¢†å–æ—¶å»¶ P95 < 2.0sï¼ˆä¸å«é“¾ä¸Šç¡®è®¤ï¼‰ï¼›
- å¹¶å‘ 1k rps ä¸‹å¹‚ç­‰/é”æ­£ç¡®æ— é‡å¤é¢†å–ï¼›
- é‚€è¯·/æ’è¡Œæ¦œ/æˆå°±åŸºç¡€é“¾è·¯å¯ç”¨ï¼›
- ä»£ä»˜é£æ§é˜ˆå€¼å¯é…ç½®å¹¶ç”Ÿæ•ˆã€‚

---

## A. æŠ€æœ¯æ ˆæ¯”å¯¹ä¸è°ƒæ•´å»ºè®®ï¼ˆå¯¹é½ä½ çš„åå¥½ï¼‰

- å‰ç«¯
  - Next.js 14ã€React 18ã€TypeScriptï¼šä¿æŒä¸€è‡´ã€‚
  - UIï¼šTailwind ä¿ç•™ï¼›å¯å¼•å…¥ Neobrutalist UI é£æ ¼åº“ä¸ Lucide React å›¾æ ‡ã€‚
  - Web3ï¼šWagmi v2 + Viem ä¿ç•™ï¼›å°†é’±åŒ…ç»„ä»¶æ›¿æ¢ä¸º RainbowKitï¼ˆåŸå…ˆç¤ºä¾‹ç”¨äº†è‡ªç ”/Privyï¼‰ã€‚
  - çŠ¶æ€/æ•°æ®ï¼šZustandã€TanStack Queryã€React Hot Toastï¼šä¿æŒä¸€è‡´ã€‚
- å®æ—¶
  - Socket.IO å®¢æˆ·ç«¯ä¿æŒï¼›è‹¥æ— è‡ªå»ºåç«¯ï¼Œå¯æ”¹ç”¨ç¬¬ä¸‰æ–¹å®æ—¶é€šé“æˆ–ä»…è½®è¯¢/å…¬å…± WSã€‚
- åç«¯ï¼ˆè‹¥ä¿ç•™åç«¯æ–¹æ¡ˆï¼‰
  - æ¡†æ¶ä» Express â†’ Fastify 4ï¼ˆæ›´å¿«ã€Zod æ ¡éªŒè‡ªç„¶æ­é…ï¼‰ã€‚
  - æ•°æ®ï¼šPrisma + PostgreSQLã€Redisï¼ˆç¼“å­˜/ä¼šè¯/Socket é€‚é…ï¼‰ä¿æŒã€‚
- åŒºå—é“¾ä¸åˆçº¦
  - ç½‘ç»œï¼šåˆ‡æ¢åˆ° Ethereum Sepoliaï¼ˆå¼€å‘/æ¼”ç¤ºï¼‰ï¼Œä¸»ç½‘åå†å†³ç­–æ˜¯å¦ Base/ä¸»ç½‘ã€‚
  - è¯­è¨€/å·¥å…·ï¼šSolidity 0.8.20ï¼ˆä½ åå¥½ï¼‰å¯è¡Œï¼›OpenZeppelin + Foundry ä¿ç•™ã€‚
  - SDKï¼šViem ä¸ºä¸»ï¼Œå¿…è¦æ—¶è¡¥å…… Ethers ä»…ç”¨äºç‰¹å®šç”Ÿæ€å·¥å…·ï¼ˆå¯é€‰ï¼‰ã€‚
- é‰´æƒä¸å®‰å…¨
  - SIWEï¼ˆSign-In with Ethereumï¼‰+ JWTï¼šæ›¿ä»£ Privy ç™»å½•æ–¹æ¡ˆã€‚
  - CORSã€é€Ÿç‡é™åˆ¶ï¼šä¿ç•™ã€‚
- æµ‹è¯•ä¸è´¨é‡
  - Vitestã€Testing Libraryã€Playwrightï¼ˆE2Eï¼‰ã€ESLintã€TS æ ¡éªŒï¼šä¿æŒã€‚
- æ„å»ºä¸å·¥å…·
  - pnpm Monorepoï¼ˆWorkspacesï¼‰ï¼šæ¨èé‡‡ç”¨ï¼Œç»Ÿä¸€å‰ç«¯/åˆçº¦/è„šæœ¬ã€‚
  - TSXã€Viteï¼ˆå†…éƒ¨å·¥å…·é¡µ/è„šæœ¬ï¼‰ï¼šå¯æŒ‰éœ€å¼•å…¥ï¼ˆNext.js ä»ç”¨å†…ç½®æ„å»ºï¼‰ã€‚
  - Dockerã€Docker Composeã€Nginxï¼ˆéƒ¨ç½²/åä»£ï¼‰ï¼šæŒ‰ä½ çš„å»ºè®®é…ç½®ã€‚

å°ç»“ï¼šæˆ‘å·²å°†æ–‡æ¡£é»˜è®¤å™è¿°ä¸­çš„ Express/Privy/Base è°ƒæ•´ä¸º Fastify/SIWE/Ethereum Sepolia ä¸ RainbowKitã€‚ä¿ç•™ Viem/Wagmi/Foundry/Prisma ç­‰æ ¸å¿ƒé€‰å‹ã€‚

---

> æ³¨ï¼šä¸Šæ–‡ B èŠ‚â€œæ— åç«¯æœåŠ¡â€ä»…ä½œæ–¹æ¡ˆè¯„ä¼°ï¼Œç°å·²â€œå½’æ¡£ï¼ˆä¸é‡‡çº³ï¼‰â€ã€‚ä¸‹æ–‡ä¸ºæœ€ç»ˆé‡‡ç”¨çš„æ ‡å‡†æ¶æ„è¯´æ˜ã€‚

## D. æ¶æ„å®šç¨¿ï¼ˆå‰åç«¯+é“¾ï¼‰

### D.1 æŠ€æœ¯åŸºçº¿
- å‰ç«¯ï¼šNext.js 14ã€React 18ã€TypeScriptã€Tailwindã€Neobrutalist UIã€Lucideã€Wagmi v2ã€RainbowKitã€Viemã€Zustandã€TanStack Queryã€React Hot Toastã€‚
- åç«¯ï¼šFastify 4ã€TypeScriptã€Zod æ ¡éªŒã€Prisma ORMã€PostgreSQLã€Redisï¼ˆç¼“å­˜/ä¼šè¯/é˜Ÿåˆ—/Socket é€‚é…ï¼‰ã€Socket.IOï¼ˆRedis Adapter å¤šå®ä¾‹ï¼‰ã€‚
- åŒºå—é“¾ä¸åˆçº¦ï¼šSolidity 0.8.20ã€Foundryã€OpenZeppelinã€Viemï¼ˆä¸ºä¸»ï¼‰/Ethersï¼ˆå¯é€‰ï¼‰ã€ç½‘ç»œï¼šEthereum Sepoliaï¼ˆæµ‹è¯•ï¼‰â†’ ä¸»ç½‘åˆ‡æ¢æŒ‰è®¡åˆ’æ‰§è¡Œã€‚
- é‰´æƒä¸å®‰å…¨ï¼šSIWEï¼ˆSign-In with Ethereumï¼‰+ JWTã€CORSã€é€Ÿç‡é™åˆ¶ã€è¾“å…¥æ ¡éªŒã€å¹‚ç­‰é”®ä¸åˆ†å¸ƒå¼é”ã€Sentry ç›‘æ§ã€‚
- æµ‹è¯•ä¸è´¨é‡ï¼šVitestã€Testing Libraryã€Playwrightï¼ˆE2Eï¼‰ã€ESLintã€TS æ ¡éªŒã€Foundry æµ‹è¯•ä¸è¦†ç›–ç‡ã€‚
- éƒ¨ç½²ï¼špnpm Monorepoã€Docker + Docker Composeã€Nginx åä»£ã€ç¯å¢ƒå˜é‡ä¸å¯†é’¥ç®¡ç†ï¼ˆ.env / Secret Managerï¼‰ã€CI/CDï¼ˆæ„å»º/è¿ç§»/å›æ»šï¼‰ã€‚

### D.2 åç«¯æœåŠ¡ç»“æ„ï¼ˆæ¦‚è¦ï¼‰
- Fastify æ¨¡å—åˆ’åˆ†ï¼š
  - `auth`ï¼ˆSIWEï¼šnonce/verify/logout/meï¼‰
  - `packets`ï¼ˆcreate/claim/refund/get/list/claimsï¼‰
  - `growth`ï¼ˆinvite/assist/leaderboard/achievementsï¼‰
  - `stats`ï¼ˆæŒ‡æ ‡èšåˆæŸ¥è¯¢ï¼‰
  - `websocket`ï¼ˆSocket.IO åˆå§‹åŒ–ä¸äº‹ä»¶ï¼‰
  - `jobs`ï¼ˆäº‹ä»¶åŒæ­¥ã€æ¦œå•é‡å»ºã€æˆå°±è®¡ç®—ï¼‰
- ä¸­é—´ä»¶ï¼šJWT é‰´æƒã€Zod æ ¡éªŒã€é€Ÿç‡é™åˆ¶ã€å¹‚ç­‰é”®ï¼›é”™è¯¯ç»Ÿä¸€å¤„ç†ã€‚
- Redisï¼š
  - KVï¼šå¹‚ç­‰é”®ã€Frame/æµç¨‹çŠ¶æ€ã€ä¸´æ—¶æ’è¡Œæ¦œç¼“å­˜
  - Pub/Subï¼šSocket.IO Redis Adapter å¹¿æ’­
  - é˜Ÿåˆ—ï¼šBullMQï¼ˆå¯é€‰ï¼‰æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡

### D.3 å…³é”®æ¥å£ä¸äº‹ä»¶ï¼ˆå¯¹é½å‰æ–‡ç« èŠ‚ï¼‰
- SIWEï¼šå‚è§ C.3ï¼ˆFastify+Zod ä¼ªä»£ç ï¼‰ï¼Œå°†è¡¥å……é”™è¯¯ç ä¸åˆ·æ–°ç­–ç•¥ã€‚
- Packetsï¼šæ²¿ç”¨ 3.x çš„ REST æ¥å£ï¼›é“¾ä¸Šäº¤äº’ç”±åç«¯ä½¿ç”¨ Viem è°ƒç”¨ï¼Œç»“åˆå¹‚ç­‰/é”ä¸é”™è¯¯é‡è¯•ã€‚
- å®æ—¶äº‹ä»¶ï¼ˆSocket.IOï¼‰ï¼š
  - æˆ¿é—´ï¼š`user:<userId>`ã€`packet:<packetId>`
  - äº‹ä»¶ï¼š`packet:created`ã€`packet:claimed`ã€`leaderboard:update`ã€`achievement:unlocked`
- ä»»åŠ¡ï¼š
  - é“¾ä¸Šæ—¥å¿—åŒæ­¥ï¼ˆ`PacketCreated/PacketClaimed`ï¼‰â†’ DB æ›´æ–° â†’ Redis ç¼“å­˜ â†’ Socket å¹¿æ’­
  - æ’è¡Œæ¦œé‡å»ºï¼ˆå‘¨/æœˆ/å®æ—¶åˆ†å±‚ï¼‰ä¸æˆå°±è¯„ä¼°

### D.4 éƒ¨ç½²åŸºçº¿
- Docker Composeï¼š`api`ï¼ˆFastifyï¼‰ã€`postgres`ã€`redis`ã€`nginx`ï¼›
- å¯åŠ¨é¡ºåºï¼šDB/Redisâ†’API è¿ç§»â†’API æœåŠ¡â†’Socket åœ¨çº¿â†’Nginx åä»£ï¼›
- ç¯å¢ƒå˜é‡æ¸…å•ï¼š`DATABASE_URL`ã€`REDIS_URL`ã€`JWT_SECRET`ã€`CHAIN_ID`ã€`RPC_URL`ã€`ALCHEMY_API_KEY`ã€`SIWE_DOMAIN`ã€`SIWE_STATEMENT`ã€`RATE_LIMIT_*` ç­‰ã€‚

---

### C.3 åç«¯ï¼ˆFastify + Zodï¼‰SIWE æ¥å£å®šä¹‰ï¼ˆä¼ªä»£ç ï¼‰
```pseudo
GET /api/auth/siwe/nonce
  res = { nonce: randomString() }

POST /api/auth/siwe/verify
  body: { message: string, signature: string }
  validate with Zod
  parsed = siweMessage.parse(message)
  assert recoveredAddress == parsed.address
  assert parsed.nonce == kv.get("siwe:nonce:"+sessionId)
  user = upsertUserByAddress(parsed.address)
  token = signJWT({ userId: user.id, address: parsed.address }, exp=7d)
  return { token, user }

POST /api/auth/logout
  invalidate session/JWT (å¯é€‰: ç»´æŠ¤ denylist)
  return { success: true }

GET /api/auth/me
  auth: JWT
  return user profile
```
- é”™è¯¯ç çº¦å®š
  - 400_BAD_REQUESTï¼šå‚æ•°é”™è¯¯/Zod æ ¡éªŒä¸é€šè¿‡/nonce å¤±æ•ˆ
  - 401_UNAUTHORIZEDï¼šç­¾åæ¢å¤åœ°å€ä¸åŒ¹é…/ç­¾åè¿‡æœŸ
  - 429_TOO_MANY_REQUESTSï¼šé€Ÿç‡é™åˆ¶
  - 500_INTERNAL_ERRORï¼šæœªçŸ¥é”™è¯¯ï¼ˆè®°å½• requestId ä¾¿äºæ’æŸ¥ï¼‰
- åˆ·æ–°ç­–ç•¥
  - ç®€åŒ–ï¼šçŸ­æœŸæ— éœ€åˆ·æ–°ç«¯ç‚¹ï¼ŒJWT è®¾ç½® 7d è¿‡æœŸï¼›å‰ç«¯è¿‡æœŸå³é‡æ–° SIWE ç™»å½•
  - å¦‚éœ€åˆ·æ–°ï¼šæä¾› `POST /api/auth/refresh`ï¼Œç”¨çŸ­æœŸ Refresh Token æ¢æ–° Access Token

---

## E. Railway éƒ¨ç½²ä¸æ•°æ®åº“ç­–ç•¥ï¼ˆMVP/å†…æµ‹ï¼‰

### E.1 æœåŠ¡ç¼–æ’
- Railway ä¸Šåˆ›å»ºä»¥ä¸‹æœåŠ¡ï¼š
  - apiï¼šFastifyï¼ˆNode 20ï¼Œpnpmï¼‰
  - postgresï¼šPostgreSQLï¼ˆé€‰æ‹©åˆé€‚çš„å­˜å‚¨ä¸å¤‡ä»½è®¡åˆ’ï¼‰
  - redisï¼šRedisï¼ˆç”¨äºç¼“å­˜/å¹‚ç­‰é”®/Socket é€‚é…ï¼‰
- ç¯å¢ƒå˜é‡ï¼ˆç¤ºä¾‹ï¼‰
  - APIï¼š`NODE_ENV=production`ã€`PORT=3001`ã€`DATABASE_URL=postgresql://...`ã€`REDIS_URL=redis://...`ã€`JWT_SECRET=...`ã€`RPC_URL=https://eth-sepolia.g.alchemy.com/v2/...`ã€`CHAIN_ID=11155111`ã€`SIWE_DOMAIN=yourdomain.com`ã€`SIWE_STATEMENT=Sign in to RedPacket`ã€`RATE_LIMIT_WINDOW_MS=60000`ã€`RATE_LIMIT_MAX=120`

### E.2 Postgres è¿æ¥ä¸æ± åŒ–é…ç½®
- æ¨èå¯ç”¨ PgBouncerï¼ˆè‹¥ Railway æä¾›ï¼‰æˆ–åœ¨ API å±‚æ§åˆ¶ Prisma è¿æ¥æ•°ï¼š
  - Prisma Clientï¼šåœ¨å•å®ä¾‹ä¸‹è®¾ç½® `connection_limit`ï¼ˆé€šè¿‡è¿æ¥ä¸²å‚æ•°æˆ– `POOL_SIZE`ï¼‰
  - Node è¿›ç¨‹å¹¶å‘ï¼šé™åˆ¶ Fastify `maxConcurrentRequests`ï¼ˆæˆ–è‡ªå®šä¹‰é™æµï¼‰
- Prisma å»ºè®®é…ç½®ï¼ˆç¤ºä¾‹è¿æ¥ä¸²ï¼‰
  - `DATABASE_URL="postgresql://user:pass@host:port/db?schema=public&connection_limit=10&pgbouncer=true"`
- API å±‚é‡è¯•ä¸é€€é¿
  - å†™å…¥å†²çªæˆ–ç¬æ—¶é”™è¯¯ï¼šæŒ‡æ•°é€€é¿ï¼ˆmax 3 æ¬¡ï¼Œåˆå§‹ 200msï¼‰

### E.3 å¤‡ä»½ç­–ç•¥
- Railway æ§åˆ¶å°ï¼šå¼€å¯æ¯æ—¥è‡ªåŠ¨å¤‡ä»½ï¼ˆå¿«ç…§/ä¿ç•™æœŸæ ¹æ®å¥—é¤ï¼‰
- è„šæœ¬åŒ–å¤‡ä»½ï¼ˆå¯é€‰ï¼‰
  - å…¨é‡ï¼š`pg_dump -Fc "$DATABASE_URL" > backup_$(date +%F).dump`
  - æ¢å¤ï¼š`pg_restore --clean --if-exists -d "$DATABASE_URL" backup_xxx.dump`
- æ¢å¤æ¼”ç»ƒ
  - æ¯æœˆè¿›è¡Œä¸€æ¬¡å¤‡ä»½æ¢å¤æ¼”ç»ƒåˆ°ä¸´æ—¶æ•°æ®åº“ï¼Œæ ¡éªŒè¿ç§»å’Œæ•°æ®å®Œæ•´æ€§

### E.4 è¿ç§»è„šæœ¬ä¸æµç¨‹ï¼ˆPrismaï¼‰
- æœ¬åœ°/CIï¼š
  - ç”Ÿæˆï¼š`pnpm prisma migrate dev --name init`
  - ç”Ÿäº§éƒ¨ç½²ï¼š`pnpm prisma migrate deploy`
  - æŸ¥çœ‹ï¼š`pnpm prisma studio`ï¼ˆéç”Ÿäº§ï¼‰
- ç°åº¦æµç¨‹
  - éƒ¨ç½²å‰ï¼šè¿è¡Œ `migrate deploy`ï¼Œé€šè¿‡åå†åˆ‡æ¢æ–°ç‰ˆæœ¬ API
  - å¤±è´¥å›æ»šï¼šä¿ç•™ä¸Šä¸€ä¸ªé•œåƒä¸è¿ç§»å›é€€è„šæœ¬ï¼ˆå¿…è¦æ—¶æ‰‹å·¥å›æ»šï¼‰

### E.5 é˜ˆå€¼ä¸è¿ç§»é¢„æ¡ˆï¼ˆåˆ° Neon/Supabaseï¼‰
- è§¦å‘é˜ˆå€¼ï¼ˆä»»ä¸€æ»¡è¶³å³è¯„ä¼°è¿ç§»ï¼‰ï¼š
  - å³°å€¼ > 200â€“300 rps æˆ–æ´»è·ƒè¿æ¥é€¼è¿‘ä¸Šé™
  - æ•°æ®åº“ä½“é‡ > 50 GB æˆ–éœ€è¦ PITR/åªè¯»å‰¯æœ¬
  - æ˜ç¡®çš„å¤šåŒºåŸŸ/é«˜å¯ç”¨éœ€æ±‚
- è¿ç§»æ­¥éª¤ï¼ˆæ¦‚è¿°ï¼‰ï¼š
  1) åœ¨æ–° PGï¼ˆNeon/Supabaseï¼‰åˆ›å»ºæ•°æ®åº“ï¼Œé…ç½®ç”¨æˆ·/æƒé™
  2) å†»ç»“å†™æµé‡ï¼ˆçŸ­æ—¶ç»´æŠ¤çª—å£ï¼‰ï¼Œ`pg_dump` å¯¼å‡º + `pg_restore` å¯¼å…¥
  3) æ›´æ–° `DATABASE_URL` åˆ°æ–°åº“ï¼Œè·‘ `migrate deploy` æ ¡éªŒ
  4) é€æ­¥æ¢å¤å†™æµé‡ä¸ç›‘æ§å‘Šè­¦

### E.6 Redis ä¸ Socket.IO
- Redisï¼šRailway Redis æˆ– Upstashï¼ˆè‹¥éœ€è¦åœ°åŸŸå°±è¿‘/æ— æœåŠ¡å™¨ï¼‰
- Socket.IOï¼šä½¿ç”¨ Redis Adapter å®ç°å¤šå®ä¾‹å¹¿æ’­ï¼›æˆ¿é—´å‘½åä¸äº‹ä»¶è§„èŒƒè§ D.3

### E.7 Nginx åä»£ï¼ˆå¯é€‰ï¼‰
- å°† `/api` è·¯ç”±ä»£ç†åˆ° Fastifyï¼Œå¯ç”¨ gzip ä¸è¿æ¥å¤ç”¨ï¼Œé™åˆ¶å¤§åŒ…ä½“ä¸è¶…æ—¶ï¼›é™æ€å‰ç«¯å¯åœ¨ Vercel æˆ–åŒæœºå®¹å™¨ã€‚

---

## ä¸‹ä¸€æ­¥å‡†å¤‡å·¥ä½œ Checklist
- è´¦æˆ·ä¸ç¯å¢ƒ
  - ç”³è¯· Alchemyï¼ˆSepoliaï¼‰ä¸ Railway è´¦æˆ·ï¼Œå¼€é€š Postgres/Redis æœåŠ¡
  - ç”³è¯· Sentry/Log ç®¡é“ï¼ˆå¯é€‰ï¼‰
- ä»“åº“ä¸ Monorepo
  - åˆå§‹åŒ– pnpm Workspacesï¼ˆapps/apiã€apps/webã€packages/contractsã€packages/sharedï¼‰
  - ç»Ÿä¸€ lintã€tsconfigã€commitlint/huskyï¼ˆå¯é€‰ï¼‰
- åç«¯è½åœ°
  - èµ·æ­¥ Fastify é¡¹ç›®éª¨æ¶ï¼ˆAuth/Packets/Growth/Stats æ¨¡å—ï¼‰
  - æ¥å…¥ Prismaï¼ˆç”Ÿæˆ schemaï¼‰ã€`migrate dev` å»ºåº“
  - æ¥å…¥ Redisï¼ˆioredisï¼‰ä¸ Socket.IOï¼ˆRedis Adapterï¼‰
  - å®ç° SIWEï¼šnonce/verify/logout/meï¼Œé”™è¯¯ç ä¸é™æµ
- åˆçº¦ä¸é“¾
  - Foundry åˆå§‹åŒ–ã€ç¼–å†™ `RedPacket.sol`ï¼ˆ0.8.20ï¼‰ä¸æµ‹è¯•
  - éƒ¨ç½²åˆ° Sepoliaï¼ˆè®°å½•åœ°å€ï¼‰ã€åœ¨ api ä¸­é…ç½® Viem å®¢æˆ·ç«¯ä¸åˆçº¦ ABI/åœ°å€
- å‰ç«¯è½åœ°
  - Next.js 14 + RainbowKit + Wagmi + Viem åŸºç¡€æ¡†æ¶
  - SIWE å‰ç«¯æµç¨‹ï¼ˆnonceâ†’ç­¾åâ†’verifyâ†’å­˜ JWTï¼‰
  - å‘/æŠ¢/é€€æ¬¾é¡µé¢ä¸åˆçº¦äº¤äº’ï¼ˆåŒ…å«äº‹ä»¶ç›‘å¬ä¸çŠ¶æ€æç¤ºï¼‰
- éƒ¨ç½²ä¸è¿ç»´
  - Railway é¡¹ç›®åˆ›å»ºä¸å˜é‡é…ç½®ï¼ŒDockerfile/Compose å‡†å¤‡
  - å¤‡ä»½ç­–ç•¥å¯ç”¨ï¼ˆæ¯æ—¥è‡ªåŠ¨ï¼‰ï¼Œè„šæœ¬åŒ–å¤‡ä»½/æ¢å¤å‘½ä»¤æ”¶å½•
  - ç›‘æ§ä¸æ—¥å¿—ï¼ˆSentry/ç»“æ„åŒ–æ—¥å¿—ï¼‰
- æ•°æ®ä¸å¢é•¿ï¼ˆå¹¶è¡Œå¯é€‰ï¼‰
  - å­å›¾/The Graph åˆç‰ˆï¼ˆå¯é€‰ï¼‰ç”¨äºåç»­æ’è¡Œæ¦œ/æˆå°±èšåˆ
  - åŸºç¡€æ’è¡Œæ¦œä¸æˆå°±è§„åˆ™è‰æ¡ˆï¼Œåç«¯ Job åè®®
