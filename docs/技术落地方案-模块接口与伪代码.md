# ğŸ§© çº¢åŒ… dApp æ¨¡å—åŒ–æŠ€æœ¯è½åœ°æ–¹æ¡ˆï¼ˆæ¥å£ä¸ä¼ªä»£ç ï¼‰

æœ¬æ–‡é¢å‘ç ”å‘è½åœ°ï¼ŒæŒ‰åŠŸèƒ½å°æ¨¡å—ç»™å‡ºï¼šç›®æ ‡ã€æŠ€æœ¯ä¾èµ–ã€æ¥å£å®šä¹‰ï¼ˆREST/WS/åˆçº¦/Frameï¼‰ã€æ•°æ®ç»“æ„ã€ä¼ªä»£ç ã€è¾¹ç•Œä¸é£æ§ã€éªŒæ”¶æµ‹è¯•è¦ç‚¹ã€‚é»˜è®¤é“¾ä¸º Baseï¼Œä¸»ä»£å¸ USDC(6 decimals)ã€‚

---

## 0. ç»Ÿä¸€çº¦å®š
- **æ ‡è¯†**ï¼š`packetId` ä½¿ç”¨åˆçº¦ä¾§ bytes32 çš„ 0x å‰ç¼€åå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼›`userId` ä¸ºåç«¯ `User.id`ï¼ˆcuidï¼‰ã€‚
- **é‡‘é¢**ï¼šé“¾ä¸Š BigIntï¼Œé“¾ä¸‹ä»¥å­—ç¬¦ä¸²å­˜å‚¨ï¼ˆæœ€å°å•ä½ï¼‰ï¼Œå‰ç«¯æ ¼å¼åŒ–æ˜¾ç¤ºã€‚
- **é‰´æƒ**ï¼š
  - Webï¼šJWT(`Authorization: Bearer <token>`)ï¼Œç­¾å‘å¯¹è±¡ä¸º `User.id`ã€‚
  - Frameï¼šFarcaster Fid è§£æ â†’ ç»‘å®š Addressï¼ˆåªè¯»ï¼‰â†’ åç«¯ä»£ç†äº¤æ˜“ã€‚
- **å¹‚ç­‰**ï¼šæ‰€æœ‰å†™æ¥å£è¦æ±‚ `Idempotency-Key`ï¼ˆUUIDï¼‰ã€‚æœåŠ¡ç«¯ä¿å­˜ 24hã€‚
- **é€Ÿç‡é™åˆ¶**ï¼šå…³é”®è·¯å¾„å¦‚ `/packets/claim`ã€`/frames/claim`ï¼ŒIP/Address/User å¤šç»´é™æµã€‚

---

## 1. æ™ºèƒ½åˆçº¦æ¨¡å—ï¼ˆRedPacket.solï¼‰

### 1.1 ç›®æ ‡
- æ”¯æŒå›ºå®š/éšæœºæ‹¼æ‰‹æ°”çº¢åŒ…ã€è¿‡æœŸé€€æ¬¾ã€äº‹ä»¶ä¸ŠæŠ¥ï¼›å¹³å°æ‰‹ç»­è´¹æ‰£é™¤ï¼›VRF éšæœºã€‚

### 1.2 ä¾èµ–
- Solidity 0.8.24 / Foundry
- OpenZeppelin ERC20/SafeERC20/ReentrancyGuard/Ownable
- Chainlink VRF v2.5ï¼ˆBaseï¼‰

### 1.3 å…³é”®æ¥å£ï¼ˆABI æ‘˜è¦ï¼‰
- `createPacket(address token, uint256 totalAmount, uint32 count, bool isRandom, uint256 duration, bytes32 salt) returns (bytes32 packetId)`
- `claimPacket(bytes32 packetId) returns (uint256 amount)`
- `refund(bytes32 packetId)`
- `getPacketInfo(bytes32) view returns (...)`
- äº‹ä»¶ï¼š`PacketCreated`, `PacketClaimed`, `PacketRefunded`ï¼Œéšæœºï¼š`RandomnessRequested`, `RandomnessFulfilled`

### 1.4 ä¼ªä»£ç ï¼ˆå…³é”®è·¯å¾„ï¼‰
```pseudo
createPacket(token, totalAmount, count, isRandom, duration, salt):
  require MIN_AMOUNT <= totalAmount <= MAX_AMOUNT
  require 0 < count <= MAX_COUNT
  require 0 < duration <= MAX_DURATION
  fee = totalAmount * platformFee / 10000
  net = totalAmount - fee
  packetId = keccak256(msg.sender, block.timestamp, salt)
  transferFrom(msg.sender, this, totalAmount)
  if fee > 0: transfer(feeCollector, fee)
  packets[packetId] = Packet{ ... net, count, expireTime, ... }
  if isRandom: requestRandomness(packetId)
  emit PacketCreated(...)
  return packetId

claimPacket(packetId):
  p = packets[packetId]
  require exists && now <= p.expireTime && p.remainingCount > 0
  require claims[packetId][msg.sender] == 0
  amount = p.isRandom ? calcRandomAmount(packetId) : p.remainingAmount / p.remainingCount
  p.remainingAmount -= amount; p.remainingCount -= 1
  claims[packetId][msg.sender] = { claimer: msg.sender, amount, ts }
  transfer(p.token, msg.sender, amount)
  emit PacketClaimed(packetId, msg.sender, amount, p.remainingCount)
  return amount

refund(packetId):
  require msg.sender == p.creator && now > p.expireTime && !p.refunded
  refundAmount = p.remainingAmount
  if refundAmount > 0:
    p.remainingAmount = 0; p.refunded = true
    transfer(p.token, p.creator, refundAmount)
    emit PacketRefunded(packetId, p.creator, refundAmount)
```

### 1.5 è¾¹ç•Œä¸é£æ§
- VRF æœªå°±ç»ª â†’ `RandomnessNotReady`ï¼Œå‰ç«¯ä¸åç«¯éœ€é‡è¯•/å¼•å¯¼ã€‚
- æœ€åä¸€ä»½éšæœºé¢†å–=å…¨éƒ¨å‰©ä½™ï¼›æœ€å°ä»½é¢ä¿æŠ¤ `minAmount`ã€‚
- å¹³å°è´¹ä¸Šé™ 5%ï¼›Owner å¯å˜æ›´è´¹ç‡/æ”¶æ¬¾äººã€‚

### 1.6 éªŒæ”¶è¦ç‚¹
- å•å…ƒæµ‹è¯•ï¼šé‡å¤é¢†å–å¤±è´¥ã€è¿‡æœŸé€€æ¬¾æ­£ç¡®ã€éšæœºæ€»å’Œå®ˆæ’ã€æ‰‹ç»­è´¹æ‰£é™¤æ­£ç¡®ã€‚

---

## 2. è´¦æˆ·ä¸ AA ä»£ä»˜æ¨¡å—ï¼ˆå¯é€‰ï¼‰

### 2.1 ç›®æ ‡
- é»˜è®¤ä½¿ç”¨å¤–éƒ¨é’±åŒ…ï¼ˆRainbowKit + SIWEï¼‰ï¼Œç”¨æˆ·è‡ªä»˜ Gasã€‚
- å¯é€‰ï¼šä¸ºç‰¹å®šç”¨æˆ·/æ´»åŠ¨æä¾› Gas ä»£ä»˜ï¼ˆPaymasterï¼‰ï¼Œæå‡æ–°ç”¨æˆ·ä½“éªŒï¼ˆé™é¢/åå•/é€Ÿç‡æ§åˆ¶ï¼‰ã€‚

### 2.2 ä¾èµ–
- å‰ç«¯ï¼šRainbowKit + SIWEï¼ˆå¤–éƒ¨é’±åŒ…ç™»å½•ï¼‰
- åç«¯ï¼šSIWE éªŒè¯ + JWT è®¤è¯ï¼ˆè§ç¬¬ 3 èŠ‚ï¼‰
- å¯é€‰ Paymasterï¼šè‡ªå»º Paymaster åˆçº¦ï¼ˆERC-4337ï¼‰æˆ–ç¬¬ä¸‰æ–¹ï¼ˆå¦‚ Alchemy, Biconomyï¼‰ï¼Œç­–ç•¥é™é¢è¡¨

### 2.3 é…ç½®ä¸æ•°æ®
- ç¯å¢ƒå˜é‡ï¼š`PAYMASTER_PRIVATE_KEY`, `PAYMASTER_MAX_DAILY_USD`, `PAYMASTER_WHITELIST`
- è¡¨ï¼š`GasPolicy(userId, dailyLimit, usedAmount, updatedAt, flags)`

### 2.4 ä¼ªä»£ç 
```pseudo
shouldSponsor(userId, action):
  policy = GasPolicy.find(userId)
  if policy.flags.contains('blocked'): return false
  if action not in ALLOWLIST_ACTIONS: return false
  usdCost = estimateActionUsd(action)
  if policy.usedAmount + usdCost > policy.dailyLimit: return false
  return true

sponsorTx(rawTx):
  signed = paymaster.signSponsored(rawTx)
  send(signed)
  update GasPolicy.usedAmount += estimateUsd(rawTx)
```

### 2.5 é£æ§
- ä»…ç™½åå•å‡½æ•°ä¸é¢åº¦ä»£ä»˜ï¼›é˜ˆå€¼ä¸é»‘åå•ï¼›å¼‚å¸¸å›æ»šä¸æŠ¥è­¦ï¼ˆSentryï¼‰ã€‚

---

## 3. Fastify æœåŠ¡ç»“æ„ä¸æ¨¡å—è¾¹ç•Œï¼ˆå®šç¨¿ï¼‰

### 3.1 ç›®å½•ç»“æ„ï¼ˆæ¨èï¼‰
```
apps/api/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts                # å…¥å£ï¼ˆæ³¨å†Œæ’ä»¶/è·¯ç”±/å¯åŠ¨ï¼‰
â”‚   â”œâ”€â”€ plugins/
â”‚   â”‚   â”œâ”€â”€ jwt.ts              # JWT æ’ä»¶å°è£…ï¼ˆdecode/authenticateï¼‰
â”‚   â”‚   â”œâ”€â”€ redis.ts            # Redis å®¢æˆ·ç«¯ï¼ˆå•ä¾‹ï¼‰
â”‚   â”‚   â””â”€â”€ prisma.ts           # Prisma Clientï¼ˆå•ä¾‹ï¼‰
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ health.ts           # /health
â”‚   â”‚   â”œâ”€â”€ auth.ts             # /api/auth (SIWE)
â”‚   â”‚   â”œâ”€â”€ packets.ts          # /api/packets
â”‚   â”‚   â”œâ”€â”€ growth/
â”‚   â”‚   â”‚   â”œâ”€â”€ invite.ts       # /api/invite
â”‚   â”‚   â”‚   â”œâ”€â”€ leaderboard.ts  # /api/leaderboard
â”‚   â”‚   â”‚   â””â”€â”€ achievements.ts # /api/achievements
â”‚   â”‚   â””â”€â”€ stats.ts            # /api/stats
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ packet.service.ts   # çº¢åŒ…ä¸šåŠ¡ï¼ˆæ ¡éªŒ/åˆ›å»º/é¢†å–/é€€æ¬¾ï¼‰
â”‚   â”‚   â”œâ”€â”€ chain.service.ts    # Viem å®¢æˆ·ç«¯ä¸é“¾ä¸Šè¯»å†™
â”‚   â”‚   â”œâ”€â”€ leaderboard.service.ts # æ’è¡Œæ¦œèšåˆ
â”‚   â”‚   â””â”€â”€ notification.service.ts # æ¨é€é€»è¾‘
â”‚   â”œâ”€â”€ websocket/
â”‚   â”‚   â””â”€â”€ io.ts               # Socket.IO + Redis Adapter
â”‚   â”œâ”€â”€ jobs/
â”‚   â”‚   â”œâ”€â”€ syncPackets.job.ts  # åŒæ­¥é“¾ä¸Šäº‹ä»¶
â”‚   â”‚   â””â”€â”€ rebuildLeaderboard.job.ts # å®šæ—¶é‡å»º
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ errors.ts           # ç»Ÿä¸€é”™è¯¯å¤„ç†
â”‚   â”‚   â”œâ”€â”€ idempotency.ts      # å¹‚ç­‰é”®ä¸­é—´ä»¶
â”‚   â”‚   â””â”€â”€ locks.ts            # åˆ†å¸ƒå¼é”
â”‚   â””â”€â”€ types/
â”‚       â””â”€â”€ index.ts            # å…±äº«ç±»å‹å®šä¹‰
â”œâ”€â”€ prisma/
â”‚   â””â”€â”€ schema.prisma
â””â”€â”€ package.json
```

### 3.2 æ¨¡å—è¾¹ç•Œ
- **è·¯ç”±å±‚ï¼ˆroutesï¼‰**ï¼šå®šä¹‰ç«¯ç‚¹ã€å‚æ•°æ ¡éªŒï¼ˆZodï¼‰ã€è°ƒç”¨ Service
- **æœåŠ¡å±‚ï¼ˆservicesï¼‰**ï¼šä¸šåŠ¡é€»è¾‘ã€æ•°æ®åº“æ“ä½œã€å¤–éƒ¨è°ƒç”¨ï¼ˆé“¾/æ¨é€ï¼‰
- **å·¥å…·å±‚ï¼ˆutilsï¼‰**ï¼šé€šç”¨ä¸­é—´ä»¶ã€é”™è¯¯å¤„ç†ã€å¹‚ç­‰/é”ã€ç±»å‹è½¬æ¢
- **WebSocket å±‚**ï¼šåˆå§‹åŒ– Socket.IOã€æˆ¿é—´ç®¡ç†ã€äº‹ä»¶å¹¿æ’­
- **ä»»åŠ¡å±‚ï¼ˆjobsï¼‰**ï¼šå®šæ—¶ä»»åŠ¡ï¼ˆäº‹ä»¶åŒæ­¥ã€æ’è¡Œæ¦œé‡å»ºï¼‰ã€é˜Ÿåˆ—ï¼ˆBullMQ å¯é€‰ï¼‰

### 3.3 ä¾èµ–æ³¨å…¥å»ºè®®
- æ’ä»¶æ³¨å†Œï¼šåœ¨ `index.ts` ä¸­å°† Prisma/Redis æ³¨å†Œä¸ºè£…é¥°å™¨ï¼ˆ`app.decorate`ï¼‰ï¼Œä¾›è·¯ç”±ä¸æœåŠ¡ä½¿ç”¨
- æœåŠ¡å•ä¾‹ï¼š`services/*.ts` å¯¼å‡ºå•ä¾‹å‡½æ•°ï¼Œæˆ–é€šè¿‡ Fastify å®ä¾‹æ³¨å…¥

---

## 3. åç«¯ APIï¼ˆExpressï¼‰ï¼ˆæ—§ç‰ˆç¤ºä¾‹ï¼Œå‚è€ƒç”¨ï¼‰

### 3.1 å‘çº¢åŒ…è®°å½•
- `POST /api/packets/create`
  - Header: `Authorization`, `Idempotency-Key`
  - Body: `{ txHash, packetId, message?, amount, count, isRandom }`
  - é€»è¾‘ï¼šæ ¡éªŒé“¾ä¸Šäº¤æ˜“æˆåŠŸ â†’ è®°å½• DB â†’ é€šçŸ¥ç²‰ä¸ â†’ è¿”å›è®°å½•
  - ä¼ªä»£ç ï¼š
```pseudo
createPacket(req):
  require auth
  ensureIdempotency(req.idemKey)
  assert verifyTxOnChain(txHash)
  upsert Packet by packetId { txHash, meta, creatorId }
  notifyFollowers(creatorId, packet.id)
  return packet
```

### 3.2 é¢†å–ï¼ˆä»£ç†ï¼‰
- `POST /api/packets/claim`
  - Header: `Authorization`, `Idempotency-Key`
  - Body: `{ packetId }`
  - é€»è¾‘ï¼šæ ¡éªŒå¯é¢†å– â†’ è°ƒç”¨åˆçº¦ â†’ è®°å½• Claim â†’ æ¨é€ WS
```pseudo
claimPacket(req):
  require auth
  ensureIdempotency
  assert canClaim(packetId, userId)
  tx = contract.claimPacket(packetId) by user/address
  amount = parseEvent(tx, PacketClaimed)
  save Claim(userId, packetId, amount, txHash)
  emitWS(packetId, 'packet:claimed', { userId, amount })
  return { amount, txHash }
```

### 3.3 æŸ¥è¯¢
- `GET /api/packets/:packetId`
- `GET /api/packets/:packetId/claims?page&limit`
- `POST /api/packets/:packetId/refund`

---

## 4. Frames é›†æˆä¸é¢†å–ä»£ç†

### 4.1 ç›®æ ‡
- åœ¨ Warpcast å†…å®Œæˆâ€œæŸ¥çœ‹â†’é¢†å–â†’ç»“æœå±•ç¤ºâ€ï¼Œåç«¯ä»£ç†å‘èµ·é“¾ä¸Šäº¤æ˜“ï¼›ä¿è¯é‰´æƒã€å¹‚ç­‰ä¸å¹¶å‘å®‰å…¨ã€‚

### 4.2 ä¾èµ–
- Frogï¼ˆNext.js Routeï¼‰
- Farcaster Hub APIï¼ˆFidâ†’Addressï¼‰
- Redis/KV ç¼“å­˜ Frame çŠ¶æ€

### 4.3 æ¥å£
- `GET/POST /api/frame/:packetId`ï¼ˆæ˜¾ç¤ºï¼‰
- `POST /api/frame/claim/:packetId`ï¼ˆé¢†å–åŠ¨ä½œï¼‰

### 4.4 ä¼ªä»£ç 
```pseudo
frameShow(packetId):
  packet = cache.getOrLoad(packetId, readContract)
  return image + intents([ Claim, Details, LinkToDapp ])

frameClaim(packetId, fid):
  ensureIdempotency(fid+packetId)
  addr = getUserAddressFromFid(fid)
  if hasClaimed(packetId, addr): return already screen
  // ç»‘å®šï¼šè‹¥ addr æœªç»‘å®šåˆ° Userï¼Œåˆ™åˆ›å»º/ç»‘å®šå½±å­ç”¨æˆ·
  user = findOrCreateUserByAddress(addr)
  if !canClaim(packetId, user.id): return error screen
  result = backendClaimProxy(packetId, user.id)
  return success screen(amount)

backendClaimProxy(packetId, userId):
  lock(packetId, userId)  // é˜²å¹¶å‘
  try:
    return POST /api/packets/claim
  finally:
    unlock
```

### 4.5 é£æ§
- é’ˆå¯¹åŒä¸€ `fid` ä¸ `packetId` åŠ åˆ†å¸ƒå¼é”ï¼›å¤±è´¥é‡è¯•é€€é¿ã€‚

---

## 5. å¢é•¿æ¨¡å—

### 5.1 é‚€è¯·å¥–åŠ±
- ç›®æ ‡ï¼šç›´æ¥/äºŒçº§é‚€è¯·ç»“ç®—ï¼›é˜²åˆ·ã€‚
- APIï¼š
  - `POST /api/invite/accept { inviterCode }`
  - `GET /api/invite/stats`
- æ•°æ®ï¼š`Invitation(inviterId, inviteeId, rewardPaid)`
- ä¼ªä»£ç ï¼š
```pseudo
acceptInvite(inviteeId, inviterCode):
  inviter = findByCode(inviterCode)
  if inviter == invitee: reject
  if exists(inviterId, inviteeId): return ok
  create Invitation()
  maybeGrantWelcomeReward(inviteeId)

settleReferralRewards(daily job):
  for each invitation:
    if invitee reached criteria (e.g., first claim or first send >= X):
      credit inviter small commission
```
- é£æ§ï¼šè®¾å¤‡/IP æŒ‡çº¹å»é‡ï¼›è¾¾åˆ°é˜ˆå€¼æ‰å‘æ”¾ã€‚

### 5.2 åŠ©åŠ›æŠ¢çº¢åŒ…
- ç›®æ ‡ï¼šè¢«é‚€è¯·è€…å®Œæˆæ³¨å†Œ/é¦–äº¤äº’åï¼Œé‚€è¯·è€…è¡¥é¢†å‰©ä½™é‡‘é¢ã€‚
- åˆçº¦ä¾§å¯é€‰ï¼šé“¾ä¸Šæ ¡éªŒ Inviteï¼ˆV2ï¼‰ï¼›MVP å…ˆé“¾ä¸‹ç»“ç®—è¡¥è´´ã€‚
- APIï¼š
  - `POST /api/assist/request { packetId }`
  - `POST /api/assist/complete { packetId, inviteeId }`
- ä¼ªä»£ç ï¼š
```pseudo
assistRequest(userId, packetId):
  create AssistTask(packetId, owner=userId, need=3)

assistComplete(packetId, inviteeId):
  mark progress; if reached need -> grant bonus(off-chain or on-chain)
```

### 5.3 æ’è¡Œæ¦œ
- å£å¾„ï¼šæ‰‹æ°”æ¦œ(å‘¨å•æ¬¡æœ€å¤§é‡‘é¢)ã€æ…·æ…¨æ¦œ(æœˆåº¦å‘å‡ºæ€»é¢)ã€æ´»è·ƒæ¦œ(å‚ä¸æ¬¡æ•°)
- APIï¼š`GET /api/leaderboard?type=luck|generous|active&range=week|month|realtime`
- ä¼ªä»£ç ï¼š
```pseudo
rebuildLeaderboard(range):
  aggregate Claims/Packets into Redis sorted sets
  expose top N with ranks
```

### 5.4 æˆå°±ç³»ç»Ÿ
- ä¾‹ï¼šé¦–æ¬¡å‘çº¢åŒ…ã€è¿ç»­ç™»å½•ã€æ‰‹æ°”æœ€ä½³x10ã€é‚€è¯·x10
- APIï¼š`GET /api/achievements`, `POST /api/achievements/check`ï¼ˆæœåŠ¡ç«¯å¼‚æ­¥è§¦å‘ï¼‰
- ä¼ªä»£ç ï¼š
```pseudo
evaluateAchievements(userId, event):
  rules = RULES[event]
  for r in rules: if r.condition(user): grantBadge(r)
```

### 5.5 çº¢åŒ…é›¨
- å®šæ—¶ä»»åŠ¡ï¼šæ¯æ—¥å›ºå®šæ—¶æ®µåˆ›å»ºå®˜æ–¹çº¢åŒ…å¹¶æ¨é€å€’è®¡æ—¶ã€‚
- ä¼ªä»£ç ï¼š
```pseudo
cron(12:00, 18:00, 22:00):
  create official Packet via admin wallet
  broadcast schedule via WS/Email/Telegram(optional)
```

### 5.6 æ¨é€é€šçŸ¥
- WebSocket ä¸ºä¸»ï¼Œé‚®ä»¶/Telegram å¯é€‰ã€‚é¢‘æ§ï¼šæ¯æ—¥ â‰¤ 3ã€‚
- äº‹ä»¶ï¼š`packet_created`, `packet_claimed`, `rank_update`ã€‚

### 5.7 å¢é•¿æ¨¡å—æ¥å£å®ç°ï¼ˆFastify + Zodï¼‰

**src/routes/growth/invite.ts**:
```typescript
import { FastifyPluginAsync } from 'fastify'
import { z } from 'zod'

const plugin: FastifyPluginAsync = async (app) => {
  app.addHook('preHandler', app.authenticate as any)

  // POST /api/invite/accept
  app.post('/accept', async (req, reply) => {
    const { inviterCode } = z.object({ inviterCode: z.string() }).parse(req.body)
    const inviteeId = (req as any).user.userId
    const inviter = await prisma.user.findUnique({ where: { inviteCode: inviterCode } })
    if (!inviter || inviter.id === inviteeId) {
      return reply.code(400).send({ error: 'INVALID_INVITER_CODE' })
    }
    await prisma.invitation.create({
      data: { inviterId: inviter.id, inviteeId },
    })
    return { success: true }
  })

  // GET /api/invite/stats
  app.get('/stats', async (req: any) => {
    const userId = req.user.userId
    const stats = await prisma.invitation.groupBy({
      by: ['rewardPaid'],
      where: { inviterId: userId },
      _count: true,
    })
    return { stats }
  })
}

export default plugin
```

**src/routes/growth/leaderboard.ts**:
```typescript
app.get('/leaderboard', async (req, reply) => {
  const { type, range } = z.object({
    type: z.enum(['luck', 'generous', 'active']),
    range: z.enum(['week', 'month', 'realtime']),
  }).parse(req.query)
  
  const key = `lb:${type}:${range}`
  const top = await redis.zrevrange(key, 0, 99, 'WITHSCORES')
  return { type, range, top }
})
```

---

## 6. åå¥³å·«ä¸é£æ§æªæ–½ï¼ˆé€Ÿç‡é™åˆ¶ã€é»‘ç™½åå•ã€é˜ˆå€¼ï¼‰

### 6.1 å¤šç»´é€Ÿç‡é™åˆ¶ï¼ˆFastifyï¼‰

**src/middleware/rateLimit.ts**:
```typescript
import { FastifyRequest, FastifyReply } from 'fastify'
import Redis from 'ioredis'

export function createRateLimiter(options: { windowMs: number; max: number; keyGen?: (req: FastifyRequest) => string }) {
  return async (req: FastifyRequest, reply: FastifyReply) => {
    const key = options.keyGen ? options.keyGen(req) : `rl:ip:${req.ip}`
    const count = await redis.incr(key)
    if (count === 1) await redis.expire(key, Math.ceil(options.windowMs / 1000))
    if (count > options.max) {
      return reply.code(429).send({ error: 'RATE_LIMIT_EXCEEDED' })
    }
  }
}
```

### 6.2 é»‘ç™½åå•ä¸å¯ç–‘åˆ†å€¼

- **é»‘åå•**ï¼šRedis Set `blacklist:address` / `blacklist:ip`
- **å¯ç–‘åˆ†å€¼**ï¼šåŸºäºå†å²è¡Œä¸ºè®¡ç®—ï¼Œè¶…è¿‡é˜ˆå€¼éœ€äººå·¥å¤æ ¸

### 6.3 é‚€è¯·æœ‰æ•ˆæ€§æ ¡éªŒ

- **é˜ˆå€¼æ¡ä»¶**ï¼šè¢«é‚€è¯·äººå®Œæˆé¦–æ¬¡å‘çº¢åŒ…æˆ–é¦–æ¬¡æŠ¢çº¢åŒ…åï¼Œæ‰ç»™é‚€è¯·äººç»“ç®—å¥–åŠ±
- **è®¾å¤‡/IP æŒ‡çº¹**ï¼šåŒä¸€è®¾å¤‡/IP é™åŒä¸€ `inviterCode` åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼ˆé˜²åˆ·ï¼‰

---

## 7. è´¹ç”¨ä¸ç»“ç®—æ¨¡å‹ï¼ˆæ‰‹ç»­è´¹ã€å¥–åŠ±æ¸…ç®—ï¼‰

### 7.1 å¹³å°æ‰‹ç»­è´¹ï¼ˆé“¾ä¸Šæ‰£é™¤ï¼‰

**åˆçº¦ä¾§ï¼ˆRedPacket.solï¼‰**:
- è´¹ç‡ï¼šé»˜è®¤ 1%ï¼ˆ100 basis pointsï¼‰ï¼ŒOwner å¯è°ƒï¼Œä¸Šé™ 5%ï¼ˆ500ï¼‰
- æ‰£é™¤æ—¶æœºï¼šåˆ›å»ºçº¢åŒ…æ—¶ä» `totalAmount` ä¸­æ‰£é™¤ï¼Œè½¬å…¥ `feeCollector`
- è®¡ç®—ï¼š`fee = totalAmount * platformFee / 10000`ï¼Œ`netAmount = totalAmount - fee`

**æ´»åŠ¨æœŸç™½åå•ï¼ˆå¯é€‰ï¼‰**:
- æ–¹æ¡ˆ Aï¼šåˆçº¦ä¾§ç»´æŠ¤ `feeWhitelist` æ˜ å°„ï¼Œç™½åå•åœ°å€æ‰‹ç»­è´¹ 0%
- æ–¹æ¡ˆ Bï¼šé“¾ä¸‹è¡¥è´´ï¼Œæ­£å¸¸æ‰£é™¤åå¹³å°è¿”è¿˜ï¼ˆéœ€è¦å•ç‹¬è½¬è´¦é€»è¾‘ï¼‰

### 7.2 é‚€è¯·ä½£é‡‘ç»“ç®—ï¼ˆé“¾ä¸‹ä½™é¢è¡¨ï¼ŒMVPï¼‰

**Prisma Schema æ‰©å±•ï¼ˆå¯é€‰ï¼‰**:
```prisma
model UserBalance {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  balance   String   @default("0") // BigInt as Stringï¼ˆUSDC æœ€å°å•ä½ï¼‰
  pending   String   @default("0") // å¾…ç»“ç®—
  updatedAt DateTime @updatedAt
}
```

**ç»“ç®—é€»è¾‘ï¼ˆsrc/services/referral.service.tsï¼‰**:
```typescript
export async function settleReferralRewards() {
  // æ¯æ—¥å®šæ—¶ä»»åŠ¡
  const pendingInvitations = await prisma.invitation.findMany({
    where: { rewardPaid: false },
    include: { invitee: true },
  })

  for (const inv of pendingInvitations) {
    // æ£€æŸ¥è¢«é‚€è¯·äººæ˜¯å¦è¾¾åˆ°æ¡ä»¶ï¼ˆé¦–å‘æˆ–é¦–é¢†ï¼‰
    const hasQualified = await checkInviteeQualified(inv.inviteeId)
    if (hasQualified) {
      // ç»™é‚€è¯·äººè®°å…¥ä½™é¢ï¼ˆé“¾ä¸‹ï¼‰
      await creditReferralReward(inv.inviterId, '2.00') // $2 USDC
      await prisma.invitation.update({
        where: { id: inv.id },
        data: { rewardPaid: true },
      })
    }
  }
}

async function creditReferralReward(userId: string, amount: string) {
  await prisma.userBalance.upsert({
    where: { userId },
    update: { balance: { increment: amount } },
    create: { userId, balance: amount },
  })
}
```

**æå–æ¥å£ï¼ˆæœªæ¥ï¼‰**:
- `POST /api/referral/withdraw { amount }` â†’ ç”¨æˆ·ç”³è¯·æç°ï¼Œåå°å®¡æ ¸åé“¾ä¸Šè½¬è´¦

### 7.3 è´¹ç”¨è´¦æœ¬ï¼ˆå®¡è®¡ç”¨ï¼Œå¯é€‰ï¼‰

å»ºè®®è®°å½•æ‰€æœ‰æ‰‹ç»­è´¹ä¸ä½£é‡‘æµæ°´åˆ°ç‹¬ç«‹è¡¨æˆ–æ—¥å¿—ï¼Œä¾¿äºå¯¹è´¦ä¸åˆè§„ã€‚

---

## 8. æ•°æ®æ¨¡å‹ï¼ˆPrisma å®Œæ•´ Schema ä¸ç´¢å¼•è¯´æ˜ï¼‰

### 8.1 å®Œæ•´ Schemaï¼ˆapps/api/prisma/schema.prismaï¼‰

```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  address       String    @unique // ä»¥å¤ªåŠåœ°å€ï¼ˆå°å†™ï¼‰
  farcasterFid  Int?      @unique
  farcasterName String?
  email         String?   @unique
  inviteCode    String    @unique @default(cuid()) // é‚€è¯·ç 
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // å…³ç³»
  createdPackets Packet[]  @relation("CreatedPackets")
  claims         Claim[]
  inviter        User?     @relation("Invitations", fields: [inviterId], references: [id])
  inviterId      String?
  invited        User[]    @relation("Invitations")
  invitations    Invitation[] @relation("Inviter")
  invitationsReceived Invitation[] @relation("Invitee")
  notifications  Notification[]
  achievements   UserAchievement[]

  @@index([address])
  @@index([farcasterFid])
  @@index([inviteCode])
  @@map("users")
}

model Packet {
  id              String    @id @default(cuid())
  packetId        String    @unique // bytes32 åå…­è¿›åˆ¶ï¼ˆé“¾ä¸Š IDï¼‰
  txHash          String    @unique // åˆ›å»ºäº¤æ˜“çš„ txHash
  creatorId       String
  creator         User      @relation("CreatedPackets", fields: [creatorId], references: [id])
  token           String    // USDC address
  totalAmount     String    // BigInt as Stringï¼ˆæœ€å°å•ä½ï¼‰
  count           Int
  isRandom        Boolean
  message         String?   @db.VarChar(200)
  remainingAmount String
  remainingCount  Int
  expireTime      DateTime
  refunded        Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  claims          Claim[]

  @@index([creatorId])
  @@index([expireTime])
  @@index([createdAt])
  @@index([packetId]) // æŸ¥è¯¢æ—¶å¸¸ç”¨
  @@map("packets")
}

model Claim {
  id        String   @id @default(cuid())
  packetId  String
  packet    Packet   @relation(fields: [packetId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  amount    String   // BigInt as String
  txHash    String   @unique
  isBest    Boolean  @default(false)
  claimedAt DateTime @default(now())

  @@unique([packetId, userId]) // é˜²æ­¢é‡å¤é¢†å–ï¼ˆDB å±‚çº¦æŸï¼‰
  @@index([packetId])
  @@index([userId])
  @@index([claimedAt])
  @@index([isBest]) // æŸ¥è¯¢"æ‰‹æ°”æœ€ä½³"ç”¨
  @@map("claims")
}

model Invitation {
  id         String   @id @default(cuid())
  inviterId  String
  inviteeId  String
  inviter    User     @relation("Inviter", fields: [inviterId], references: [id])
  invitee    User     @relation("Invitee", fields: [inviteeId], references: [id])
  rewardPaid Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@unique([inviterId, inviteeId])
  @@index([inviterId])
  @@index([inviteeId])
  @@map("invitations")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   // packet_created, packet_claimed, rank_update, achievement_unlocked
  title     String   @db.VarChar(200)
  content   String   @db.Text
  data      Json?    // é¢å¤–æ•°æ®ï¼ˆpacketIdã€amount ç­‰ï¼‰
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, read]) // æŸ¥è¯¢æœªè¯»æ•°
  @@index([createdAt])
  @@index([type]) // æŒ‰ç±»å‹ç­›é€‰
  @@map("notifications")
}

model UserAchievement {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  code        String    // æˆå°±ä»£ç ï¼ˆé¦–æ¬¡å‘çº¢åŒ…ã€è¿ç»­ç™»å½•ç­‰ï¼‰
  unlockedAt  DateTime  @default(now())
  metadata    Json?     // é¢å¤–æ•°æ®

  @@unique([userId, code])
  @@index([userId])
  @@index([code])
  @@map("user_achievements")
}
```

### 8.2 ç´¢å¼•ç­–ç•¥è¯´æ˜

- **å”¯ä¸€ç´¢å¼•**ï¼š`User.address`ã€`User.farcasterFid`ã€`User.inviteCode`ã€`Packet.packetId`ã€`Packet.txHash`ã€`Claim.txHash`ã€`Claim(packetId, userId)`ã€`Invitation(inviterId, inviteeId)`ã€`UserAchievement(userId, code)`
- **æŸ¥è¯¢ç´¢å¼•**ï¼š`User.address/farcasterFid/inviteCode`ã€`Packet.creatorId/expireTime/createdAt/packetId`ã€`Claim.packetId/userId/claimedAt/isBest`ã€`Invitation.inviterId/inviteeId`ã€`Notification(userId, read)/createdAt/type`ã€`UserAchievement.userId/code`
- **å¤åˆç´¢å¼•**ï¼š`Notification(userId, read)` ç”¨äºæœªè¯»æŸ¥è¯¢ï¼›å…¶ä½™ç»„åˆæ ¹æ®å®é™…æŸ¥è¯¢æ¨¡å¼è¿½åŠ 

### 8.3 å®¡è®¡æ—¥å¿—å»ºè®®ï¼ˆå¯é€‰æ‰©å±•ï¼‰

- **æ–¹æ¡ˆ A**ï¼šåœ¨å…³é”®è¡¨åŠ å®¡è®¡å­—æ®µï¼ˆ`createdBy`ã€`updatedBy`ã€`deletedAt`ã€`version`ï¼‰
- **æ–¹æ¡ˆ B**ï¼šç‹¬ç«‹å®¡è®¡è¡¨ï¼ˆ`AuditLog`ï¼‰è®°å½•æ“ä½œç±»å‹ã€è¡¨åã€è®°å½• IDã€å˜æ›´å‰åå€¼ã€æ“ä½œäººã€æ—¶é—´æˆ³
- **å»ºè®®**ï¼šMVP é˜¶æ®µå¯é€‰ï¼›è‹¥éœ€åˆè§„ï¼Œä¼˜å…ˆ AuditLog

### 8.4 æŸ¥è¯¢ä¼˜åŒ–æç¤º

- **åˆ†é¡µ**ï¼šä½¿ç”¨ `cursor` åˆ†é¡µï¼ˆåŸºäº `createdAt`ï¼‰ä¼˜äº `offset`ï¼›å¤§åˆ—è¡¨é…åˆ `take/skip` æ—¶éœ€æ³¨æ„åç§»æ€§èƒ½
- **é¢„åŠ è½½**ï¼š`Packet` æŸ¥è¯¢æ—¶æŒ‰éœ€ `include` `creator`/`claims`ï¼ˆé¿å… N+1ï¼‰
- **æ‰¹é‡**ï¼šæ’è¡Œæ¦œ/ç»Ÿè®¡å¯ç”¨ Prisma èšåˆå‡½æ•°æˆ– Raw SQLï¼›å¤æ‚èšåˆè€ƒè™‘è¯»å‰¯æœ¬

---

## 9. å®æ—¶ä¸ä»»åŠ¡

### 9.1 Socket.IO + Redis Adapter åˆå§‹åŒ–

**src/websocket/io.ts**:
```typescript
import { Server } from 'socket.io'
import { createAdapter } from '@socket.io/redis-adapter'
import { createClient } from 'redis'

export async function initIO(server: any) {
  const io = new Server(server, { cors: { origin: true, credentials: true } })
  const pub = createClient({ url: process.env.REDIS_URL })
  const sub = pub.duplicate()
  await Promise.all([pub.connect(), sub.connect()])
  io.adapter(createAdapter(pub, sub))

  io.use(async (socket, next) => {
    const token = socket.handshake.auth?.token
    if (!token) return next(new Error('AUTH_REQUIRED'))
    // éªŒè¯ JWT -> socket.data.userId
    next()
  })

  io.on('connection', (socket) => {
    socket.join(`user:${socket.data.userId}`)
    socket.on('subscribe:packet', (pid: string) => socket.join(`packet:${pid}`))
    socket.on('unsubscribe:packet', (pid: string) => socket.leave(`packet:${pid}`))
  })
  return io
}
```

### 9.2 äº‹ä»¶å‘½åè§„èŒƒ

- **Client â†’ Server**: `subscribe:packet`, `unsubscribe:packet`
- **Server â†’ Client**: 
  - `packet:created` â†’ `{ packetId, creatorId, totalAmount, count }`
  - `packet:claimed` â†’ `{ packetId, claimer, amount, remainingCount }`
  - `leaderboard:update` â†’ `{ type, range, top: [...] }`
  - `achievement:unlocked` â†’ `{ userId, code }`
  - `notification:new` â†’ `{ id, type, title, content }`
- **æˆ¿é—´**: `user:<userId>`, `packet:<packetId>`

### 9.3 é“¾ä¸Šäº‹ä»¶åŒæ­¥ä»»åŠ¡

å®šæ—¶ä»»åŠ¡ï¼ˆæ¯30ç§’ï¼‰ï¼šè¯»å– `PacketClaimed` æ—¥å¿— â†’ æ›´æ–° DB â†’ Socket.IO å¹¿æ’­ã€‚

### 9.4 å®šæ—¶ä»»åŠ¡

- æ’è¡Œæ¦œé‡å»ºï¼šæ¯å°æ—¶ï¼Œä» DB èšåˆåˆ° Redis Sorted Set
- æˆå°±è¯„ä¼°ï¼šäº‹ä»¶è§¦å‘æ—¶æ‰§è¡Œ
- å¤±è´¥é‡è¯•ï¼šBullMQï¼ˆå¯é€‰ï¼‰æˆ–ç®€å•é‡è¯•æœºåˆ¶

---

## 10. æµ‹è¯•ä¸ç›‘æ§ç­–ç•¥ï¼ˆå•å…ƒ/é›†æˆ/E2Eã€æ—¥å¿—ã€æŠ¥è­¦ï¼‰

### 10.1 åˆçº¦æµ‹è¯•ï¼ˆFoundryï¼‰

**æµ‹è¯•æ–‡ä»¶ç»“æ„**:
```
contracts/
  â”œâ”€â”€ src/
  â”‚   â””â”€â”€ RedPacket.sol
  â””â”€â”€ test/
      â”œâ”€â”€ RedPacket.t.sol          # åŸºç¡€åŠŸèƒ½æµ‹è¯•
      â”œâ”€â”€ RedPacketFuzz.t.sol      # Fuzz æµ‹è¯•
      â””â”€â”€ RedPacketInvariant.t.sol # ä¸å˜æ€§æµ‹è¯•
```

**æµ‹è¯•è¦†ç›–**:
- **å•å…ƒæµ‹è¯•**ï¼šåˆ›å»ºçº¢åŒ…ã€é¢†å–çº¢åŒ…ã€é€€æ¬¾ã€æ‰‹ç»­è´¹è®¡ç®—ã€éšæœºæ•°éªŒè¯
- **Fuzz æµ‹è¯•**ï¼šé‡‘é¢è¾¹ç•Œã€æ•°é‡è¾¹ç•Œã€æ—¶é—´è¾¹ç•Œ
- **Gas ä¼˜åŒ–**ï¼šè®°å½• gas æ¶ˆè€—ï¼Œå¯¹æ¯”ä¼˜åŒ–å‰å
- **è¦†ç›–ç‡ç›®æ ‡**ï¼š> 90%

**ç¤ºä¾‹ï¼ˆtest/RedPacket.t.solï¼‰**:
```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import {Test, console} from "forge-std/Test.sol";
import {RedPacket} from "../src/RedPacket.sol";

contract RedPacketTest is Test {
    RedPacket public packet;
    address public owner = address(0x1);
    address public user;

    function setUp() public {
        vm.prank(owner);
        packet = new RedPacket();
        user = address(0x2);
        deal(user, 100 ether);
    }

    function testCreatePacket() public {
        vm.prank(user);
        uint256 packetId = packet.create{value: 10 ether}(10, 3600, "");
        assertEq(packet.getPacket(packetId).creator, user);
        assertEq(packet.getPacket(packetId).totalAmount, 10 ether);
    }

    function testClaimRandomness() public {
        // æµ‹è¯•éšæœºæ•°æ€»å’Œå®ˆæ’
        vm.prank(user);
        uint256 pid = packet.create{value: 10 ether}(10, 3600, "");
        uint256 totalClaimed = 0;
        for (uint256 i = 0; i < 10; i++) {
            address claimer = address(uint160(i + 100));
            deal(claimer, 1 ether);
            vm.prank(claimer);
            (uint256 amount, ) = packet.claim(pid);
            totalClaimed += amount;
        }
        assertEq(totalClaimed, 10 ether);
    }
}
```

**è¿è¡Œå‘½ä»¤**:
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
forge test

# å¸¦è¦†ç›–ç‡
forge coverage --report lcov

# Gas æŠ¥å‘Š
forge test --gas-report
```

### 10.2 åç«¯æµ‹è¯•ï¼ˆVitest + Supertestï¼‰

**æµ‹è¯•æ–‡ä»¶ç»“æ„**:
```
apps/api/
  â”œâ”€â”€ src/
  â””â”€â”€ test/
      â”œâ”€â”€ unit/           # å•å…ƒæµ‹è¯•ï¼ˆservice/utilsï¼‰
      â”œâ”€â”€ integration/    # é›†æˆæµ‹è¯•ï¼ˆroutesï¼‰
      â””â”€â”€ fixtures/       # æµ‹è¯•æ•°æ®
```

**å•å…ƒæµ‹è¯•ç¤ºä¾‹ï¼ˆtest/unit/services/packet.service.test.tsï¼‰**:
```typescript
import { describe, it, expect, beforeAll, afterAll } from 'vitest'
import { prisma } from '@/lib/prisma'
import { createPacket } from '@/services/packet.service'

describe('Packet Service', () => {
  beforeAll(async () => {
    await prisma.$connect()
  })

  afterAll(async () => {
    await prisma.$disconnect()
  })

  it('should create packet with valid data', async () => {
    const userId = 'test-user-id'
    const packet = await createPacket({
      userId,
      totalAmount: '1000000', // 1 USDC
      totalCount: 10,
      expireSeconds: 3600,
    })
    expect(packet).toBeDefined()
    expect(packet.totalAmount).toBe('1000000')
  })

  it('should reject duplicate claim', async () => {
    // æµ‹è¯•å¹‚ç­‰æ€§
  })
})
```

**é›†æˆæµ‹è¯•ç¤ºä¾‹ï¼ˆtest/integration/routes/packet.test.tsï¼‰**:
```typescript
import { describe, it, expect } from 'vitest'
import { build } from '@/app'
import { generateJWT } from '@/utils/auth'

describe('POST /api/packets', () => {
  it('should create packet with auth', async () => {
    const app = await build()
    const token = generateJWT({ userId: 'test-user', address: '0x123' })
    const response = await app.inject({
      method: 'POST',
      url: '/api/packets',
      headers: { authorization: `Bearer ${token}` },
      payload: {
        totalAmount: '1000000',
        totalCount: 10,
        expireSeconds: 3600,
      },
    })
    expect(response.statusCode).toBe(200)
    const data = JSON.parse(response.body)
    expect(data.packetId).toBeDefined()
  })
})
```

**è¿è¡Œå‘½ä»¤**:
```bash
# å•å…ƒ + é›†æˆæµ‹è¯•
pnpm test

# è¦†ç›–ç‡
pnpm test:coverage

# Watch æ¨¡å¼
pnpm test:watch
```

### 10.4 å‰ç«¯æµ‹è¯•ï¼ˆVitest + Testing Libraryï¼‰

**æµ‹è¯•æ–‡ä»¶ç»“æ„**:
```
apps/web/
  â”œâ”€â”€ src/
  â””â”€â”€ __tests__/
      â”œâ”€â”€ components/
      â”œâ”€â”€ hooks/
      â””â”€â”€ utils/
```

**ç»„ä»¶æµ‹è¯•ç¤ºä¾‹ï¼ˆ__tests__/components/PacketCard.test.tsxï¼‰**:
```typescript
import { describe, it, expect } from 'vitest'
import { render, screen } from '@testing-library/react'
import { PacketCard } from '@/components/PacketCard'

describe('PacketCard', () => {
  it('should render packet info', () => {
    render(<PacketCard packetId="test-123" amount="100" count={10} />)
    expect(screen.getByText(/100/)).toBeInTheDocument()
    expect(screen.getByText(/10/)).toBeInTheDocument()
  })
})
```

### 10.5 E2E æµ‹è¯•ï¼ˆPlaywrightï¼‰

**E2E æµ‹è¯•æ–‡ä»¶ï¼ˆe2e/packet-flow.spec.tsï¼‰**:
```typescript
import { test, expect } from '@playwright/test'

test.describe('Packet Flow', () => {
  test('create and claim packet', async ({ page }) => {
    // 1. è¿æ¥é’±åŒ…
    await page.goto('/')
    await page.click('button:has-text("Connect Wallet")')
    await page.click('button:has-text("MetaMask")')
    // æ¨¡æ‹Ÿé’±åŒ…ç¡®è®¤...

    // 2. åˆ›å»ºçº¢åŒ…
    await page.fill('[name="amount"]', '100')
    await page.fill('[name="count"]', '10')
    await page.click('button:has-text("Create")')
    await expect(page.locator('.success-message')).toBeVisible()

    // 3. é¢†å–çº¢åŒ…
    const packetLink = await page.locator('.packet-link').textContent()
    await page.goto(`/packet/${packetLink}`)
    await page.click('button:has-text("Claim")')
    await expect(page.locator('.claimed-amount')).toBeVisible()
  })
})
```

**è¿è¡Œå‘½ä»¤**:
```bash
# è¿è¡Œ E2E æµ‹è¯•
pnpm test:e2e

# UI æ¨¡å¼
pnpm test:e2e:ui
```

### 10.6 ç›‘æ§ä¸æ—¥å¿—

**ç»“æ„åŒ–æ—¥å¿—ï¼ˆpinoï¼‰**:
```typescript
// src/utils/logger.ts
import pino from 'pino'

export const logger = pino({
  level: process.env.LOG_LEVEL || 'info',
  transport: process.env.NODE_ENV === 'development' ? {
    target: 'pino-pretty',
  } : undefined,
})

// ä½¿ç”¨ç¤ºä¾‹
logger.info({ userId, packetId, amount }, 'Packet created')
logger.error({ err, packetId }, 'Claim failed')
```

**Sentry é›†æˆï¼ˆé”™è¯¯è¿½è¸ªï¼‰**:
```typescript
// src/utils/sentry.ts
import * as Sentry from '@sentry/node'

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 0.1,
})

// Fastify é”™è¯¯å¤„ç†
app.setErrorHandler((err, req, reply) => {
  Sentry.captureException(err, {
    tags: { route: req.url },
    extra: { userId: req.user?.userId },
  })
  reply.code(500).send({ error: 'INTERNAL_ERROR' })
})
```

**å…³é”®æŒ‡æ ‡ä»ªè¡¨ç›˜ï¼ˆè‡ªå®šä¹‰ Metricsï¼‰**:
```typescript
// src/metrics/index.ts
import { Counter, Histogram } from 'prom-client'

export const packetCreated = new Counter({
  name: 'packets_created_total',
  help: 'Total packets created',
})

export const claimLatency = new Histogram({
  name: 'claim_duration_seconds',
  help: 'Claim operation duration',
  buckets: [0.1, 0.5, 1, 2, 5],
})

// ä½¿ç”¨
packetCreated.inc()
claimLatency.observe(duration)
```

**å…³é”®æŒ‡æ ‡**:
- **ä¸šåŠ¡æŒ‡æ ‡**ï¼šK-Factorï¼ˆé‚€è¯·ç‡ï¼‰ã€D1/D7/D30 ç•™å­˜ã€ARPUã€çº¢åŒ…å®Œæˆç‡
- **æŠ€æœ¯æŒ‡æ ‡**ï¼šAPI å“åº”æ—¶é—´ P95/P99ã€é”™è¯¯ç‡ã€WebSocket è¿æ¥æ•°ã€æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡
- **é“¾ä¸ŠæŒ‡æ ‡**ï¼šGas æ¶ˆè€—ã€äº¤æ˜“ç¡®è®¤æ—¶é—´ã€åˆçº¦è°ƒç”¨æˆåŠŸç‡

**æŠ¥è­¦è§„åˆ™**ï¼ˆç¤ºä¾‹ï¼‰:
- API P95 å“åº”æ—¶é—´ > 2s â†’ å‘Šè­¦
- é”™è¯¯ç‡ > 1% â†’ å‘Šè­¦
- æ•°æ®åº“è¿æ¥æ± è€—å°½ â†’ ç´§æ€¥å‘Šè­¦
- çº¢åŒ…é¢†å–å¤±è´¥ç‡ > 5% â†’ å‘Šè­¦

---

## 11. éƒ¨ç½²ä¸é…ç½®æ¸…å•ï¼ˆç¯å¢ƒå˜é‡ã€ç§˜é’¥ã€CI/CDï¼‰

### 11.1 ç¯å¢ƒå˜é‡æ¸…å•ï¼ˆå®Œæ•´ç‰ˆï¼‰

**åç«¯ï¼ˆapps/api/.env.exampleï¼‰**:
```bash
# æœåŠ¡ç«¯å£
PORT=3000
NODE_ENV=production

# æ•°æ®åº“
DATABASE_URL="postgresql://user:password@host:5432/dbname?schema=public"
DATABASE_POOL_SIZE=10

# Redis
REDIS_URL="redis://:password@host:6379"
REDIS_TLS=false

# JWT è®¤è¯
JWT_SECRET="your-256-bit-secret-key-here"
JWT_EXPIRES_IN="7d"
SIWE_DOMAIN="your-app.com"
SIWE_STATEMENT="Sign in to HongBao dApp"

# åŒºå—é“¾
ETHEREUM_RPC_URL="https://sepolia.infura.io/v3/YOUR_KEY"
ETHEREUM_CHAIN_ID=11155111
RED_PACKET_CONTRACT_ADDRESS="0x..."
USDC_CONTRACT_ADDRESS="0x..."
CONTRACT_OWNER_PRIVATE_KEY="0x..." # ä»…ç”¨äºç®¡ç†æ“ä½œï¼ˆæ‰‹ç»­è´¹è®¾ç½®ç­‰ï¼‰

# ç›‘æ§
SENTRY_DSN="https://..."
LOG_LEVEL="info"

# CORS
CORS_ORIGIN="https://your-app.com,https://*.vercel.app"

# é€Ÿç‡é™åˆ¶ï¼ˆå¯é€‰ï¼‰
RATE_LIMIT_WINDOW_MS=60000
RATE_LIMIT_MAX_REQUESTS=100

# Farcasterï¼ˆå¯é€‰ï¼‰
FARCASTER_API_KEY=""
FARCASTER_WEBHOOK_SECRET=""
```

**å‰ç«¯ï¼ˆapps/web/.env.exampleï¼‰**:
```bash
NEXT_PUBLIC_API_URL="https://api.your-app.com"
NEXT_PUBLIC_CHAIN_ID=11155111
NEXT_PUBLIC_RPC_URL="https://sepolia.infura.io/v3/YOUR_KEY"
NEXT_PUBLIC_RED_PACKET_CONTRACT="0x..."
NEXT_PUBLIC_USDC_CONTRACT="0x..."
NEXT_PUBLIC_APP_NAME="HongBao"
NEXT_PUBLIC_APP_URL="https://your-app.com"
```

### 11.2 Docker Compose é…ç½®ï¼ˆæœ¬åœ°å¼€å‘/ç”Ÿäº§ï¼‰

**docker-compose.yml**:
```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: redpacket
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: redpacket
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U redpacket"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      DATABASE_URL: postgresql://redpacket:${POSTGRES_PASSWORD}@postgres:5432/redpacket
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      JWT_SECRET: ${JWT_SECRET}
      # ... å…¶ä»–ç¯å¢ƒå˜é‡
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
```

**apps/api/Dockerfile**:
```dockerfile
FROM node:20-alpine AS base
WORKDIR /app
RUN corepack enable && corepack prepare pnpm@8.15.0 --activate

FROM base AS deps
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/api/package.json ./apps/api/
COPY packages/*/package.json ./packages/*/
RUN pnpm install --frozen-lockfile

FROM base AS builder
COPY --from=deps /app/node_modules ./node_modules
COPY . .
WORKDIR /app/apps/api
RUN pnpm build

FROM base AS runner
ENV NODE_ENV=production
COPY --from=builder /app/apps/api/dist ./dist
COPY --from=builder /app/apps/api/package.json ./
COPY --from=deps /app/node_modules ./node_modules
EXPOSE 3000
CMD ["node", "dist/index.js"]
```

### 11.3 Nginx é…ç½®ï¼ˆåå‘ä»£ç†ï¼‰

**nginx.conf**:
```nginx
upstream api_backend {
    server api:3000;
    keepalive 32;
}

server {
    listen 80;
    server_name api.your-app.com;

    # SSL é‡å®šå‘ï¼ˆç”Ÿäº§ç¯å¢ƒåº”å¯ç”¨ HTTPSï¼‰
    # return 301 https://$server_name$request_uri;

    location / {
        proxy_pass http://api_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400; # WebSocket æ”¯æŒ
    }

    # WebSocket æ”¯æŒ
    location /socket.io/ {
        proxy_pass http://api_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

### 11.4 Railway éƒ¨ç½²é…ç½®

**railway.json**ï¼ˆRailway é…ç½®ï¼‰:
```json
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS",
    "buildCommand": "cd apps/api && pnpm install && pnpm build"
  },
  "deploy": {
    "startCommand": "cd apps/api && node dist/index.js",
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
```

**Prisma Migrationï¼ˆRailway éƒ¨ç½²è„šæœ¬ï¼‰**:
```bash
#!/bin/bash
# railway-deploy.sh

# ç­‰å¾…æ•°æ®åº“å°±ç»ª
until pg_isready -h $DATABASE_HOST -p $DATABASE_PORT -U $DATABASE_USER; do
  echo "Waiting for database..."
  sleep 2
done

# è¿è¡Œè¿ç§»
cd apps/api
pnpm prisma migrate deploy

# ç”Ÿæˆ Prisma Client
pnpm prisma generate

# å¯åŠ¨æœåŠ¡
node dist/index.js
```

### 11.5 CI/CD é…ç½®ï¼ˆGitHub Actionsï¼‰

**.github/workflows/ci.yml**:
```yaml
name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 8.15.0
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Lint
        run: pnpm lint
      
      - name: Test (Backend)
        run: cd apps/api && pnpm test
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          REDIS_URL: redis://localhost:6379
      
      - name: Test (Frontend)
        run: cd apps/web && pnpm test
      
      - name: Build
        run: pnpm build

  deploy-staging:
    needs: test
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Staging
        run: |
          # Railway CLI éƒ¨ç½²åˆ° staging
          railway up --service staging-api

  deploy-production:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Production
        run: |
          # Railway CLI éƒ¨ç½²åˆ° production
          railway up --service production-api
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
```

### 11.6 ç§˜é’¥ç®¡ç†ï¼ˆSecret Managementï¼‰

**æ¨èæ–¹æ¡ˆ**:
- **å¼€å‘ç¯å¢ƒ**ï¼š`.env` æ–‡ä»¶ï¼ˆå·²åŠ å…¥ `.gitignore`ï¼‰
- **Staging/Production**ï¼šRailway Secrets / Vercel Environment Variables
- **æ•æ„Ÿç§˜é’¥**ï¼ˆç§é’¥ã€JWT Secretï¼‰ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œç»ä¸æäº¤åˆ°ä»£ç åº“

**ç§˜é’¥æ¸…å•**:
- âœ… `JWT_SECRET` - è‡³å°‘ 256 ä½éšæœºå­—ç¬¦ä¸²
- âœ… `CONTRACT_OWNER_PRIVATE_KEY` - åˆçº¦ Owner ç§é’¥ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
- âœ… `DATABASE_URL` - æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼ˆå«å¯†ç ï¼‰
- âœ… `REDIS_URL` - Redis è¿æ¥å­—ç¬¦ä¸²ï¼ˆå«å¯†ç ï¼‰
- âœ… `ALCHEMY_API_KEY` / `INFURA_API_KEY` - RPC æä¾›è€…å¯†é’¥
- âœ… `SENTRY_DSN` - Sentry é”™è¯¯è¿½è¸ªå¯†é’¥
- âš ï¸ `FARCASTER_API_KEY` - Farcaster API å¯†é’¥ï¼ˆå¯é€‰ï¼‰

### 11.7 è¿ç§»ä¸å›æ»šè®¡åˆ’

**æ•°æ®åº“è¿ç§»**:
```bash
# åˆ›å»ºè¿ç§»
cd apps/api
pnpm prisma migrate dev --name migration_name

# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è¿ç§»
pnpm prisma migrate deploy

# å›æ»šï¼ˆæ‰‹åŠ¨ï¼‰
pnpm prisma migrate resolve --rolled-back migration_name
```

**ä»£ç å›æ»šï¼ˆRailwayï¼‰**:
- é€šè¿‡ Railway Dashboard é€‰æ‹©ä¹‹å‰çš„éƒ¨ç½²ç‰ˆæœ¬ï¼Œä¸€é”®å›æ»š
- æˆ–é€šè¿‡ CLIï¼š`railway rollback`

**åˆçº¦å‡çº§**ï¼ˆå¦‚éœ€ï¼‰:
- ä½¿ç”¨ Proxy Patternï¼ˆå¦‚ OpenZeppelin Upgradeableï¼‰æˆ–æ–°åˆçº¦éƒ¨ç½² + æ•°æ®è¿ç§»

---

## 12. éªŒæ”¶æ¸…å•ï¼ˆMVPï¼‰
- å‘/æŠ¢/é€€æ¬¾å…¨é“¾è·¯æˆåŠŸç‡ > 99%ï¼›
- Frame é¢†å–æ—¶å»¶ P95 < 2.0sï¼ˆä¸å«é“¾ä¸Šç¡®è®¤ï¼‰ï¼›
- å¹¶å‘ 1k rps ä¸‹å¹‚ç­‰/é”æ­£ç¡®æ— é‡å¤é¢†å–ï¼›
- é‚€è¯·/æ’è¡Œæ¦œ/æˆå°±åŸºç¡€é“¾è·¯å¯ç”¨ï¼›
- ä»£ä»˜é£æ§é˜ˆå€¼å¯é…ç½®å¹¶ç”Ÿæ•ˆã€‚

---

## A. æŠ€æœ¯æ ˆæ¯”å¯¹ä¸è°ƒæ•´å»ºè®®ï¼ˆå¯¹é½ä½ çš„åå¥½ï¼‰

- å‰ç«¯
  - Next.js 14ã€React 18ã€TypeScriptï¼šä¿æŒä¸€è‡´ã€‚
  - UIï¼šTailwind ä¿ç•™ï¼›å¯å¼•å…¥ Neobrutalist UI é£æ ¼åº“ä¸ Lucide React å›¾æ ‡ã€‚
  - Web3ï¼šWagmi v2 + Viem ä¿ç•™ï¼›å°†é’±åŒ…ç»„ä»¶æ›¿æ¢ä¸º RainbowKitï¼ˆåŸå…ˆç¤ºä¾‹ç”¨äº†è‡ªç ”/Privyï¼‰ã€‚
  - çŠ¶æ€/æ•°æ®ï¼šZustandã€TanStack Queryã€React Hot Toastï¼šä¿æŒä¸€è‡´ã€‚
- å®æ—¶
  - Socket.IO å®¢æˆ·ç«¯ä¿æŒï¼›è‹¥æ— è‡ªå»ºåç«¯ï¼Œå¯æ”¹ç”¨ç¬¬ä¸‰æ–¹å®æ—¶é€šé“æˆ–ä»…è½®è¯¢/å…¬å…± WSã€‚
- åç«¯ï¼ˆè‹¥ä¿ç•™åç«¯æ–¹æ¡ˆï¼‰
  - æ¡†æ¶ä» Express â†’ Fastify 4ï¼ˆæ›´å¿«ã€Zod æ ¡éªŒè‡ªç„¶æ­é…ï¼‰ã€‚
  - æ•°æ®ï¼šPrisma + PostgreSQLã€Redisï¼ˆç¼“å­˜/ä¼šè¯/Socket é€‚é…ï¼‰ä¿æŒã€‚
- åŒºå—é“¾ä¸åˆçº¦
  - ç½‘ç»œï¼šåˆ‡æ¢åˆ° Ethereum Sepoliaï¼ˆå¼€å‘/æ¼”ç¤ºï¼‰ï¼Œä¸»ç½‘åå†å†³ç­–æ˜¯å¦ Base/ä¸»ç½‘ã€‚
  - è¯­è¨€/å·¥å…·ï¼šSolidity 0.8.20ï¼ˆä½ åå¥½ï¼‰å¯è¡Œï¼›OpenZeppelin + Foundry ä¿ç•™ã€‚
  - SDKï¼šViem ä¸ºä¸»ï¼Œå¿…è¦æ—¶è¡¥å…… Ethers ä»…ç”¨äºç‰¹å®šç”Ÿæ€å·¥å…·ï¼ˆå¯é€‰ï¼‰ã€‚
- é‰´æƒä¸å®‰å…¨
  - SIWEï¼ˆSign-In with Ethereumï¼‰+ JWTï¼šæ›¿ä»£ Privy ç™»å½•æ–¹æ¡ˆã€‚
  - CORSã€é€Ÿç‡é™åˆ¶ï¼šä¿ç•™ã€‚
- æµ‹è¯•ä¸è´¨é‡
  - Vitestã€Testing Libraryã€Playwrightï¼ˆE2Eï¼‰ã€ESLintã€TS æ ¡éªŒï¼šä¿æŒã€‚
- æ„å»ºä¸å·¥å…·
  - pnpm Monorepoï¼ˆWorkspacesï¼‰ï¼šæ¨èé‡‡ç”¨ï¼Œç»Ÿä¸€å‰ç«¯/åˆçº¦/è„šæœ¬ã€‚
  - TSXã€Viteï¼ˆå†…éƒ¨å·¥å…·é¡µ/è„šæœ¬ï¼‰ï¼šå¯æŒ‰éœ€å¼•å…¥ï¼ˆNext.js ä»ç”¨å†…ç½®æ„å»ºï¼‰ã€‚
  - Dockerã€Docker Composeã€Nginxï¼ˆéƒ¨ç½²/åä»£ï¼‰ï¼šæŒ‰ä½ çš„å»ºè®®é…ç½®ã€‚

å°ç»“ï¼šæˆ‘å·²å°†æ–‡æ¡£é»˜è®¤å™è¿°ä¸­çš„ Express/Privy/Base è°ƒæ•´ä¸º Fastify/SIWE/Ethereum Sepolia ä¸ RainbowKitã€‚ä¿ç•™ Viem/Wagmi/Foundry/Prisma ç­‰æ ¸å¿ƒé€‰å‹ã€‚

---

> æ³¨ï¼šä¸Šæ–‡ B èŠ‚â€œæ— åç«¯æœåŠ¡â€ä»…ä½œæ–¹æ¡ˆè¯„ä¼°ï¼Œç°å·²â€œå½’æ¡£ï¼ˆä¸é‡‡çº³ï¼‰â€ã€‚ä¸‹æ–‡ä¸ºæœ€ç»ˆé‡‡ç”¨çš„æ ‡å‡†æ¶æ„è¯´æ˜ã€‚

## D. æ¶æ„å®šç¨¿ï¼ˆå‰åç«¯+é“¾ï¼‰

### D.1 æŠ€æœ¯åŸºçº¿
- å‰ç«¯ï¼šNext.js 14ã€React 18ã€TypeScriptã€Tailwindã€Neobrutalist UIã€Lucideã€Wagmi v2ã€RainbowKitã€Viemã€Zustandã€TanStack Queryã€React Hot Toastã€‚
- åç«¯ï¼šFastify 4ã€TypeScriptã€Zod æ ¡éªŒã€Prisma ORMã€PostgreSQLã€Redisï¼ˆç¼“å­˜/ä¼šè¯/é˜Ÿåˆ—/Socket é€‚é…ï¼‰ã€Socket.IOï¼ˆRedis Adapter å¤šå®ä¾‹ï¼‰ã€‚
- åŒºå—é“¾ä¸åˆçº¦ï¼šSolidity 0.8.20ã€Foundryã€OpenZeppelinã€Viemï¼ˆä¸ºä¸»ï¼‰/Ethersï¼ˆå¯é€‰ï¼‰ã€ç½‘ç»œï¼šEthereum Sepoliaï¼ˆæµ‹è¯•ï¼‰â†’ ä¸»ç½‘åˆ‡æ¢æŒ‰è®¡åˆ’æ‰§è¡Œã€‚
- é‰´æƒä¸å®‰å…¨ï¼šSIWEï¼ˆSign-In with Ethereumï¼‰+ JWTã€CORSã€é€Ÿç‡é™åˆ¶ã€è¾“å…¥æ ¡éªŒã€å¹‚ç­‰é”®ä¸åˆ†å¸ƒå¼é”ã€Sentry ç›‘æ§ã€‚
- æµ‹è¯•ä¸è´¨é‡ï¼šVitestã€Testing Libraryã€Playwrightï¼ˆE2Eï¼‰ã€ESLintã€TS æ ¡éªŒã€Foundry æµ‹è¯•ä¸è¦†ç›–ç‡ã€‚
- éƒ¨ç½²ï¼špnpm Monorepoã€Docker + Docker Composeã€Nginx åä»£ã€ç¯å¢ƒå˜é‡ä¸å¯†é’¥ç®¡ç†ï¼ˆ.env / Secret Managerï¼‰ã€CI/CDï¼ˆæ„å»º/è¿ç§»/å›æ»šï¼‰ã€‚

### D.2 åç«¯æœåŠ¡ç»“æ„ï¼ˆæ¦‚è¦ï¼‰
- Fastify æ¨¡å—åˆ’åˆ†ï¼š
  - `auth`ï¼ˆSIWEï¼šnonce/verify/logout/meï¼‰
  - `packets`ï¼ˆcreate/claim/refund/get/list/claimsï¼‰
  - `growth`ï¼ˆinvite/assist/leaderboard/achievementsï¼‰
  - `stats`ï¼ˆæŒ‡æ ‡èšåˆæŸ¥è¯¢ï¼‰
  - `websocket`ï¼ˆSocket.IO åˆå§‹åŒ–ä¸äº‹ä»¶ï¼‰
  - `jobs`ï¼ˆäº‹ä»¶åŒæ­¥ã€æ¦œå•é‡å»ºã€æˆå°±è®¡ç®—ï¼‰
- ä¸­é—´ä»¶ï¼šJWT é‰´æƒã€Zod æ ¡éªŒã€é€Ÿç‡é™åˆ¶ã€å¹‚ç­‰é”®ï¼›é”™è¯¯ç»Ÿä¸€å¤„ç†ã€‚
- Redisï¼š
  - KVï¼šå¹‚ç­‰é”®ã€Frame/æµç¨‹çŠ¶æ€ã€ä¸´æ—¶æ’è¡Œæ¦œç¼“å­˜
  - Pub/Subï¼šSocket.IO Redis Adapter å¹¿æ’­
  - é˜Ÿåˆ—ï¼šBullMQï¼ˆå¯é€‰ï¼‰æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡

### D.3 å…³é”®æ¥å£ä¸äº‹ä»¶ï¼ˆå¯¹é½å‰æ–‡ç« èŠ‚ï¼‰
- SIWEï¼šå‚è§ C.3ï¼ˆFastify+Zod ä¼ªä»£ç ï¼‰ï¼Œå°†è¡¥å……é”™è¯¯ç ä¸åˆ·æ–°ç­–ç•¥ã€‚
- Packetsï¼šæ²¿ç”¨ 3.x çš„ REST æ¥å£ï¼›é“¾ä¸Šäº¤äº’ç”±åç«¯ä½¿ç”¨ Viem è°ƒç”¨ï¼Œç»“åˆå¹‚ç­‰/é”ä¸é”™è¯¯é‡è¯•ã€‚
- å®æ—¶äº‹ä»¶ï¼ˆSocket.IOï¼‰ï¼š
  - æˆ¿é—´ï¼š`user:<userId>`ã€`packet:<packetId>`
  - äº‹ä»¶ï¼š`packet:created`ã€`packet:claimed`ã€`leaderboard:update`ã€`achievement:unlocked`
- ä»»åŠ¡ï¼š
  - é“¾ä¸Šæ—¥å¿—åŒæ­¥ï¼ˆ`PacketCreated/PacketClaimed`ï¼‰â†’ DB æ›´æ–° â†’ Redis ç¼“å­˜ â†’ Socket å¹¿æ’­
  - æ’è¡Œæ¦œé‡å»ºï¼ˆå‘¨/æœˆ/å®æ—¶åˆ†å±‚ï¼‰ä¸æˆå°±è¯„ä¼°

### D.4 éƒ¨ç½²åŸºçº¿
- Docker Composeï¼š`api`ï¼ˆFastifyï¼‰ã€`postgres`ã€`redis`ã€`nginx`ï¼›
- å¯åŠ¨é¡ºåºï¼šDB/Redisâ†’API è¿ç§»â†’API æœåŠ¡â†’Socket åœ¨çº¿â†’Nginx åä»£ï¼›
- ç¯å¢ƒå˜é‡æ¸…å•ï¼š`DATABASE_URL`ã€`REDIS_URL`ã€`JWT_SECRET`ã€`CHAIN_ID`ã€`RPC_URL`ã€`ALCHEMY_API_KEY`ã€`SIWE_DOMAIN`ã€`SIWE_STATEMENT`ã€`RATE_LIMIT_*` ç­‰ã€‚

---

### C.3 åç«¯ï¼ˆFastify + Zodï¼‰SIWE æ¥å£å®šä¹‰ï¼ˆä¼ªä»£ç ï¼‰
```pseudo
GET /api/auth/siwe/nonce
  res = { nonce: randomString() }

POST /api/auth/siwe/verify
  body: { message: string, signature: string }
  validate with Zod
  parsed = siweMessage.parse(message)
  assert recoveredAddress == parsed.address
  assert parsed.nonce == kv.get("siwe:nonce:"+sessionId)
  user = upsertUserByAddress(parsed.address)
  token = signJWT({ userId: user.id, address: parsed.address }, exp=7d)
  return { token, user }

POST /api/auth/logout
  invalidate session/JWT (å¯é€‰: ç»´æŠ¤ denylist)
  return { success: true }

GET /api/auth/me
  auth: JWT
  return user profile
```
- é”™è¯¯ç çº¦å®š
  - 400_BAD_REQUESTï¼šå‚æ•°é”™è¯¯/Zod æ ¡éªŒä¸é€šè¿‡/nonce å¤±æ•ˆ
  - 401_UNAUTHORIZEDï¼šç­¾åæ¢å¤åœ°å€ä¸åŒ¹é…/ç­¾åè¿‡æœŸ
  - 429_TOO_MANY_REQUESTSï¼šé€Ÿç‡é™åˆ¶
  - 500_INTERNAL_ERRORï¼šæœªçŸ¥é”™è¯¯ï¼ˆè®°å½• requestId ä¾¿äºæ’æŸ¥ï¼‰
- åˆ·æ–°ç­–ç•¥
  - ç®€åŒ–ï¼šçŸ­æœŸæ— éœ€åˆ·æ–°ç«¯ç‚¹ï¼ŒJWT è®¾ç½® 7d è¿‡æœŸï¼›å‰ç«¯è¿‡æœŸå³é‡æ–° SIWE ç™»å½•
  - å¦‚éœ€åˆ·æ–°ï¼šæä¾› `POST /api/auth/refresh`ï¼Œç”¨çŸ­æœŸ Refresh Token æ¢æ–° Access Token

**å®Œæ•´å®ç°ä»£ç ï¼ˆsrc/routes/auth.tsï¼‰**:
```typescript
import { FastifyPluginAsync } from 'fastify'
import { z } from 'zod'
import { SiweMessage } from 'siwe'
import Redis from 'ioredis'

const redis = new Redis(process.env.REDIS_URL!)

const plugin: FastifyPluginAsync = async (app) => {
  // GET /api/auth/siwe/nonce
  app.get('/siwe/nonce', async () => {
    const nonce = crypto.randomUUID()
    await redis.setex(`siwe:nonce:${nonce}`, 300, '1')
    return { nonce }
  })

  // POST /api/auth/siwe/verify
  app.post('/siwe/verify', async (req, reply) => {
    const body = z.object({
      message: z.string(),
      signature: z.string().regex(/^0x[a-fA-F0-9]+$/),
    }).parse(req.body)

    const msg = new SiweMessage(body.message)
    const fields = await msg.validate(body.signature)
    const nonceValid = await redis.del(`siwe:nonce:${fields.nonce}`)
    if (nonceValid === 0) {
      return reply.code(400).send({ error: 'INVALID_NONCE' })
    }
    
    // upsert user & sign JWT
    const user = await upsertUserByAddress(fields.address.toLowerCase())
    const token = app.jwt.sign({ userId: user.id, address: user.address }, { expiresIn: '7d' })
    return { token, user: { id: user.id, address: user.address } }
  })

  // GET /api/auth/me
  app.get('/me', { preHandler: [app.authenticate as any] }, async (req: any) => {
    return await getUserById(req.user.userId)
  })
}

export default plugin
```

---

## E. Railway éƒ¨ç½²ä¸æ•°æ®åº“ç­–ç•¥ï¼ˆMVP/å†…æµ‹ï¼‰

### E.1 æœåŠ¡ç¼–æ’
- Railway ä¸Šåˆ›å»ºä»¥ä¸‹æœåŠ¡ï¼š
  - apiï¼šFastifyï¼ˆNode 20ï¼Œpnpmï¼‰
  - postgresï¼šPostgreSQLï¼ˆé€‰æ‹©åˆé€‚çš„å­˜å‚¨ä¸å¤‡ä»½è®¡åˆ’ï¼‰
  - redisï¼šRedisï¼ˆç”¨äºç¼“å­˜/å¹‚ç­‰é”®/Socket é€‚é…ï¼‰
- ç¯å¢ƒå˜é‡ï¼ˆç¤ºä¾‹ï¼‰
  - APIï¼š`NODE_ENV=production`ã€`PORT=3001`ã€`DATABASE_URL=postgresql://...`ã€`REDIS_URL=redis://...`ã€`JWT_SECRET=...`ã€`RPC_URL=https://eth-sepolia.g.alchemy.com/v2/...`ã€`CHAIN_ID=11155111`ã€`SIWE_DOMAIN=yourdomain.com`ã€`SIWE_STATEMENT=Sign in to RedPacket`ã€`RATE_LIMIT_WINDOW_MS=60000`ã€`RATE_LIMIT_MAX=120`

### E.2 Postgres è¿æ¥ä¸æ± åŒ–é…ç½®
- æ¨èå¯ç”¨ PgBouncerï¼ˆè‹¥ Railway æä¾›ï¼‰æˆ–åœ¨ API å±‚æ§åˆ¶ Prisma è¿æ¥æ•°ï¼š
  - Prisma Clientï¼šåœ¨å•å®ä¾‹ä¸‹è®¾ç½® `connection_limit`ï¼ˆé€šè¿‡è¿æ¥ä¸²å‚æ•°æˆ– `POOL_SIZE`ï¼‰
  - Node è¿›ç¨‹å¹¶å‘ï¼šé™åˆ¶ Fastify `maxConcurrentRequests`ï¼ˆæˆ–è‡ªå®šä¹‰é™æµï¼‰
- Prisma å»ºè®®é…ç½®ï¼ˆç¤ºä¾‹è¿æ¥ä¸²ï¼‰
  - `DATABASE_URL="postgresql://user:pass@host:port/db?schema=public&connection_limit=10&pgbouncer=true"`
- API å±‚é‡è¯•ä¸é€€é¿
  - å†™å…¥å†²çªæˆ–ç¬æ—¶é”™è¯¯ï¼šæŒ‡æ•°é€€é¿ï¼ˆmax 3 æ¬¡ï¼Œåˆå§‹ 200msï¼‰

### E.3 å¤‡ä»½ç­–ç•¥
- Railway æ§åˆ¶å°ï¼šå¼€å¯æ¯æ—¥è‡ªåŠ¨å¤‡ä»½ï¼ˆå¿«ç…§/ä¿ç•™æœŸæ ¹æ®å¥—é¤ï¼‰
- è„šæœ¬åŒ–å¤‡ä»½ï¼ˆå¯é€‰ï¼‰
  - å…¨é‡ï¼š`pg_dump -Fc "$DATABASE_URL" > backup_$(date +%F).dump`
  - æ¢å¤ï¼š`pg_restore --clean --if-exists -d "$DATABASE_URL" backup_xxx.dump`
- æ¢å¤æ¼”ç»ƒ
  - æ¯æœˆè¿›è¡Œä¸€æ¬¡å¤‡ä»½æ¢å¤æ¼”ç»ƒåˆ°ä¸´æ—¶æ•°æ®åº“ï¼Œæ ¡éªŒè¿ç§»å’Œæ•°æ®å®Œæ•´æ€§

### E.4 è¿ç§»è„šæœ¬ä¸æµç¨‹ï¼ˆPrismaï¼‰
- æœ¬åœ°/CIï¼š
  - ç”Ÿæˆï¼š`pnpm prisma migrate dev --name init`
  - ç”Ÿäº§éƒ¨ç½²ï¼š`pnpm prisma migrate deploy`
  - æŸ¥çœ‹ï¼š`pnpm prisma studio`ï¼ˆéç”Ÿäº§ï¼‰
- ç°åº¦æµç¨‹
  - éƒ¨ç½²å‰ï¼šè¿è¡Œ `migrate deploy`ï¼Œé€šè¿‡åå†åˆ‡æ¢æ–°ç‰ˆæœ¬ API
  - å¤±è´¥å›æ»šï¼šä¿ç•™ä¸Šä¸€ä¸ªé•œåƒä¸è¿ç§»å›é€€è„šæœ¬ï¼ˆå¿…è¦æ—¶æ‰‹å·¥å›æ»šï¼‰

### E.5 é˜ˆå€¼ä¸è¿ç§»é¢„æ¡ˆï¼ˆåˆ° Neon/Supabaseï¼‰
- è§¦å‘é˜ˆå€¼ï¼ˆä»»ä¸€æ»¡è¶³å³è¯„ä¼°è¿ç§»ï¼‰ï¼š
  - å³°å€¼ > 200â€“300 rps æˆ–æ´»è·ƒè¿æ¥é€¼è¿‘ä¸Šé™
  - æ•°æ®åº“ä½“é‡ > 50 GB æˆ–éœ€è¦ PITR/åªè¯»å‰¯æœ¬
  - æ˜ç¡®çš„å¤šåŒºåŸŸ/é«˜å¯ç”¨éœ€æ±‚
- è¿ç§»æ­¥éª¤ï¼ˆæ¦‚è¿°ï¼‰ï¼š
  1) åœ¨æ–° PGï¼ˆNeon/Supabaseï¼‰åˆ›å»ºæ•°æ®åº“ï¼Œé…ç½®ç”¨æˆ·/æƒé™
  2) å†»ç»“å†™æµé‡ï¼ˆçŸ­æ—¶ç»´æŠ¤çª—å£ï¼‰ï¼Œ`pg_dump` å¯¼å‡º + `pg_restore` å¯¼å…¥
  3) æ›´æ–° `DATABASE_URL` åˆ°æ–°åº“ï¼Œè·‘ `migrate deploy` æ ¡éªŒ
  4) é€æ­¥æ¢å¤å†™æµé‡ä¸ç›‘æ§å‘Šè­¦

### E.6 Redis ä¸ Socket.IO
- Redisï¼šRailway Redis æˆ– Upstashï¼ˆè‹¥éœ€è¦åœ°åŸŸå°±è¿‘/æ— æœåŠ¡å™¨ï¼‰
- Socket.IOï¼šä½¿ç”¨ Redis Adapter å®ç°å¤šå®ä¾‹å¹¿æ’­ï¼›æˆ¿é—´å‘½åä¸äº‹ä»¶è§„èŒƒè§ D.3

### E.7 Nginx åä»£ï¼ˆå¯é€‰ï¼‰
- å°† `/api` è·¯ç”±ä»£ç†åˆ° Fastifyï¼Œå¯ç”¨ gzip ä¸è¿æ¥å¤ç”¨ï¼Œé™åˆ¶å¤§åŒ…ä½“ä¸è¶…æ—¶ï¼›é™æ€å‰ç«¯å¯åœ¨ Vercel æˆ–åŒæœºå®¹å™¨ã€‚

---

## ä¸‹ä¸€æ­¥å‡†å¤‡å·¥ä½œ Checklist
- è´¦æˆ·ä¸ç¯å¢ƒ
  - ç”³è¯· Alchemyï¼ˆSepoliaï¼‰ä¸ Railway è´¦æˆ·ï¼Œå¼€é€š Postgres/Redis æœåŠ¡
  - ç”³è¯· Sentry/Log ç®¡é“ï¼ˆå¯é€‰ï¼‰
- ä»“åº“ä¸ Monorepo
  - åˆå§‹åŒ– pnpm Workspacesï¼ˆapps/apiã€apps/webã€packages/contractsã€packages/sharedï¼‰
  - ç»Ÿä¸€ lintã€tsconfigã€commitlint/huskyï¼ˆå¯é€‰ï¼‰
- åç«¯è½åœ°
  - èµ·æ­¥ Fastify é¡¹ç›®éª¨æ¶ï¼ˆAuth/Packets/Growth/Stats æ¨¡å—ï¼‰
  - æ¥å…¥ Prismaï¼ˆç”Ÿæˆ schemaï¼‰ã€`migrate dev` å»ºåº“
  - æ¥å…¥ Redisï¼ˆioredisï¼‰ä¸ Socket.IOï¼ˆRedis Adapterï¼‰
  - å®ç° SIWEï¼šnonce/verify/logout/meï¼Œé”™è¯¯ç ä¸é™æµ
- åˆçº¦ä¸é“¾
  - Foundry åˆå§‹åŒ–ã€ç¼–å†™ `RedPacket.sol`ï¼ˆ0.8.20ï¼‰ä¸æµ‹è¯•
  - éƒ¨ç½²åˆ° Sepoliaï¼ˆè®°å½•åœ°å€ï¼‰ã€åœ¨ api ä¸­é…ç½® Viem å®¢æˆ·ç«¯ä¸åˆçº¦ ABI/åœ°å€
- å‰ç«¯è½åœ°
  - Next.js 14 + RainbowKit + Wagmi + Viem åŸºç¡€æ¡†æ¶
  - SIWE å‰ç«¯æµç¨‹ï¼ˆnonceâ†’ç­¾åâ†’verifyâ†’å­˜ JWTï¼‰
  - å‘/æŠ¢/é€€æ¬¾é¡µé¢ä¸åˆçº¦äº¤äº’ï¼ˆåŒ…å«äº‹ä»¶ç›‘å¬ä¸çŠ¶æ€æç¤ºï¼‰
- éƒ¨ç½²ä¸è¿ç»´
  - Railway é¡¹ç›®åˆ›å»ºä¸å˜é‡é…ç½®ï¼ŒDockerfile/Compose å‡†å¤‡
  - å¤‡ä»½ç­–ç•¥å¯ç”¨ï¼ˆæ¯æ—¥è‡ªåŠ¨ï¼‰ï¼Œè„šæœ¬åŒ–å¤‡ä»½/æ¢å¤å‘½ä»¤æ”¶å½•
  - ç›‘æ§ä¸æ—¥å¿—ï¼ˆSentry/ç»“æ„åŒ–æ—¥å¿—ï¼‰
- æ•°æ®ä¸å¢é•¿ï¼ˆå¹¶è¡Œå¯é€‰ï¼‰
  - å­å›¾/The Graph åˆç‰ˆï¼ˆå¯é€‰ï¼‰ç”¨äºåç»­æ’è¡Œæ¦œ/æˆå°±èšåˆ
  - åŸºç¡€æ’è¡Œæ¦œä¸æˆå°±è§„åˆ™è‰æ¡ˆï¼Œåç«¯ Job åè®®
