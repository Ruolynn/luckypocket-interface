# DeGift å¼€å‘å¯åŠ¨æŒ‡å¼•

**å¼€å‘è€…**: Claude Dev (AI å¼€å‘åŠ©æ‰‹)
**é¡¹ç›®ç»ç†**: Claude PM (AI é¡¹ç›®ç®¡ç†åŠ©æ‰‹)
**å‘å¸ƒæ—¥æœŸ**: 2025-11-03

---

## ğŸ¯ æ¬¢è¿ï¼

ä½ å°†è´Ÿè´£å¼€å‘ DeGift é¡¹ç›®çš„æ‰€æœ‰ä»£ç å·¥ä½œã€‚é¡¹ç›®å·²ç»åœ¨ Linear ä¸­å®Œæ•´è§„åˆ’ï¼Œå…±åˆ†ä¸º 4 ä¸ª Phaseï¼Œ16 ä¸ªå­ä»»åŠ¡ã€‚

**é‡è¦**:
- âœ… è¯·ä¸¥æ ¼æŒ‰ç…§ Phase 1 â†’ 2 â†’ 3 â†’ 4 çš„é¡ºåºå¼€å‘
- âœ… æ¯å®Œæˆä¸€ä¸ªä»»åŠ¡ï¼Œå‘ŠçŸ¥é¡¹ç›®ç»ç†è¿›è¡ŒéªŒæ”¶
- âœ… åªæœ‰é€šè¿‡éªŒæ”¶åæ‰èƒ½è¿›å…¥ä¸‹ä¸€ä¸ªä»»åŠ¡
- âœ… é‡åˆ°ä»»ä½•é—®é¢˜ç«‹å³å‘é¡¹ç›®ç»ç†åé¦ˆ

---

## ğŸ“‹ ç¬¬ä¸€é˜¶æ®µä»»åŠ¡ï¼šPhase 1 - åˆçº¦å±‚

### ğŸ¯ å½“å‰ä»»åŠ¡ï¼šZES-69 - DeGift æ™ºèƒ½åˆçº¦è®¾è®¡å’Œå¼€å‘

**Linear é“¾æ¥**: https://linear.app/zesty-studio/issue/ZES-69

#### ä»»åŠ¡æè¿°

è®¾è®¡å’Œå¼€å‘ DeGift æ™ºèƒ½åˆçº¦ï¼Œæ‰©å±•ç°æœ‰ HongBaoPacket.sol åŠŸèƒ½ã€‚

#### å…·ä½“è¦æ±‚

**1. åˆçº¦è®¾è®¡**
- [ ] é˜…è¯»å¹¶åˆ†æ `packages/contracts/src/HongBaoPacket.sol`
- [ ] è®¾è®¡ DeGift åˆçº¦çš„æ ¸å¿ƒæ¥å£
- [ ] å®šä¹‰ Gift æ•°æ®ç»“æ„ï¼ˆå‚è€ƒçº¢åŒ…çš„ Packet ç»“æ„ï¼‰
- [ ] è®¾è®¡çŠ¶æ€ç®¡ç†é€»è¾‘ï¼ˆPENDING, CLAIMED, REFUNDED, EXPIREDï¼‰

**2. æ ¸å¿ƒåŠŸèƒ½å¼€å‘**
åˆ›å»ºæ–°æ–‡ä»¶ï¼š`packages/contracts/src/DeGift.sol`

å¿…é¡»å®ç°çš„å‡½æ•°ï¼š
```solidity
// åˆ›å»ºç¤¼ç‰©
function createGift(
    address recipient,
    address token,  // address(0) for ETH
    uint256 amount,
    string memory message,
    uint256 expiresAt
) external payable returns (uint256 giftId);

// é¢†å–ç¤¼ç‰©
function claimGift(uint256 giftId) external;

// é€€å›ç¤¼ç‰©
function refundGift(uint256 giftId) external;

// æŸ¥è¯¢ç¤¼ç‰©è¯¦æƒ…
function getGift(uint256 giftId) external view returns (Gift memory);
```

**3. å¤šä»£å¸æ”¯æŒ**
- [ ] æ”¯æŒ ETH åŸç”Ÿä»£å¸ï¼ˆmsg.valueï¼‰
- [ ] æ”¯æŒ ERC20 ä»£å¸ï¼ˆSafeERC20ï¼‰
- [ ] æ­£ç¡®å¤„ç†ä»£å¸è½¬è´¦å’Œæˆæƒ
- [ ] é˜²æ­¢é‡å…¥æ”»å‡»

**4. äº‹ä»¶å’Œé”™è¯¯**
```solidity
// äº‹ä»¶
event GiftCreated(uint256 indexed giftId, address indexed sender, address indexed recipient);
event GiftClaimed(uint256 indexed giftId, address indexed claimer);
event GiftRefunded(uint256 indexed giftId, address indexed sender);

// è‡ªå®šä¹‰é”™è¯¯
error GiftNotFound();
error GiftAlreadyClaimed();
error GiftExpired();
error NotGiftRecipient();
error NotGiftSender();
```

#### å‚è€ƒèµ„æº

**å¿…è¯»ä»£ç **:
- `packages/contracts/src/HongBaoPacket.sol` - çº¢åŒ…åˆçº¦å®ç°
- `packages/contracts/test/HongBaoPacket.t.sol` - çº¢åŒ…æµ‹è¯•ç¤ºä¾‹

**å‚è€ƒæ–‡æ¡£**:
- `docs/çº¢åŒ…dApp-PRD.md` - äº§å“éœ€æ±‚æ–‡æ¡£
- `docs/æŠ€æœ¯è½åœ°æ–¹æ¡ˆ-æ¨¡å—æ¥å£ä¸ä¼ªä»£ç .md` - æŠ€æœ¯æ–¹æ¡ˆ

**æŠ€æœ¯æ ˆ**:
- Solidity 0.8.20
- OpenZeppelin Contracts
- Foundry æµ‹è¯•æ¡†æ¶

#### éªŒæ”¶æ ‡å‡†ï¼ˆé¡¹ç›®ç»ç†ä¼šæ£€æŸ¥ï¼‰

- [ ] åˆçº¦ç¼–è¯‘é€šè¿‡ï¼š`forge build` æ— é”™è¯¯æ— è­¦å‘Š
- [ ] ä»£ç ç¬¦åˆ Solidity 0.8.20 è§„èŒƒ
- [ ] å®Œæ•´çš„ NatSpec æ³¨é‡Šï¼ˆ@notice, @param, @returnï¼‰
- [ ] Gas ä¼˜åŒ–ï¼ˆä½¿ç”¨ custom errors æ›¿ä»£ require stringsï¼‰
- [ ] ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
- [ ] æ‰€æœ‰æ ¸å¿ƒå‡½æ•°éƒ½å·²å®ç°

#### é¢„è®¡æ—¶é—´
3-4 å¤©

---

## ğŸ”„ å¼€å‘æµç¨‹

### æ­¥éª¤ 1: å¼€å§‹ä»»åŠ¡
å½“ä½ å¼€å§‹è¿™ä¸ªä»»åŠ¡æ—¶ï¼Œå‘Šè¯‰é¡¹ç›®ç»ç†ï¼š
```
"æˆ‘å¼€å§‹å¼€å‘ ZES-69 - DeGift æ™ºèƒ½åˆçº¦"
```

é¡¹ç›®ç»ç†ä¼šåœ¨ Linear ä¸­å°†ä»»åŠ¡çŠ¶æ€æ›´æ–°ä¸º "In Progress"ã€‚

### æ­¥éª¤ 2: å¼€å‘è¿‡ç¨‹
1. åˆ›å»ºæ–°æ–‡ä»¶ `packages/contracts/src/DeGift.sol`
2. å‚è€ƒ HongBaoPacket.sol çš„ç»“æ„
3. å®ç°æ‰€æœ‰å¿…éœ€çš„å‡½æ•°
4. æ·»åŠ å®Œæ•´çš„æ³¨é‡Š
5. ç¡®ä¿ä»£ç ç¼–è¯‘é€šè¿‡

### æ­¥éª¤ 3: è‡ªæ£€æ¸…å•
å®Œæˆåï¼Œè‡ªå·±å…ˆæ£€æŸ¥ï¼š
- [ ] ä»£ç å¯ä»¥ç¼–è¯‘ï¼ˆ`forge build`ï¼‰
- [ ] æ‰€æœ‰å‡½æ•°éƒ½å®ç°äº†
- [ ] æ³¨é‡Šå®Œæ•´
- [ ] æ²¡æœ‰æ˜æ˜¾çš„ bug

### æ­¥éª¤ 4: æäº¤éªŒæ”¶
å‘Šè¯‰é¡¹ç›®ç»ç†ï¼š
```
"ZES-69 å·²å®Œæˆï¼Œè¯·éªŒæ”¶ã€‚
æ–‡ä»¶ä½ç½®ï¼špackages/contracts/src/DeGift.sol
ç¼–è¯‘çŠ¶æ€ï¼šé€šè¿‡
ä¸»è¦å®ç°ï¼š
- createGift å‡½æ•°
- claimGift å‡½æ•°
- refundGift å‡½æ•°
- getGift æŸ¥è¯¢å‡½æ•°
- å®Œæ•´çš„äº‹ä»¶å’Œé”™è¯¯å®šä¹‰
"
```

### æ­¥éª¤ 5: ç­‰å¾…éªŒæ”¶
é¡¹ç›®ç»ç†ä¼šï¼š
1. æ£€æŸ¥ä»£ç æ–‡ä»¶
2. è¿è¡Œç¼–è¯‘æµ‹è¯•
3. å¯¹ç…§éªŒæ”¶æ ‡å‡†é€é¡¹æ£€æŸ¥
4. æŸ¥çœ‹æ˜¯å¦ç¬¦åˆäº§å“æ–‡æ¡£è¦æ±‚

**éªŒæ”¶ç»“æœ**:
- âœ… **é€šè¿‡**: å¯ä»¥è¿›å…¥ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼ˆZES-70ï¼‰
- âŒ **éœ€è¦ä¿®æ”¹**: é¡¹ç›®ç»ç†ä¼šåˆ—å‡ºéœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼Œä¿®æ”¹åé‡æ–°éªŒæ”¶

---

## ğŸ“Š Phase 1 å®Œæ•´ä»»åŠ¡åˆ—è¡¨

å®Œæˆ ZES-69 åï¼Œæ¥ä¸‹æ¥çš„ä»»åŠ¡æ˜¯ï¼š

1. âœ… **ZES-69**: DeGift æ™ºèƒ½åˆçº¦è®¾è®¡å’Œå¼€å‘ (å½“å‰ä»»åŠ¡)
2. â³ **ZES-70**: NFT ç¤¼ç‰©æ”¯æŒé›†æˆ
3. â³ **ZES-71**: åˆçº¦æµ‹è¯•å’Œå®¡è®¡
4. â³ **ZES-72**: Base æµ‹è¯•ç½‘éƒ¨ç½²

**åªæœ‰å‰ä¸€ä¸ªä»»åŠ¡éªŒæ”¶é€šè¿‡ï¼Œæ‰èƒ½å¼€å§‹ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼**

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### ä»£ç è§„èŒƒ
- ä½¿ç”¨ Solidity 0.8.20
- éµå¾ª OpenZeppelin çš„å®‰å…¨æœ€ä½³å®è·µ
- ä½¿ç”¨ custom errors èŠ‚çœ gas
- æ·»åŠ å®Œæ•´çš„ NatSpec æ³¨é‡Š

### å®‰å…¨è€ƒè™‘
- é˜²æ­¢é‡å…¥æ”»å‡»ï¼ˆä½¿ç”¨ ReentrancyGuardï¼‰
- æ£€æŸ¥æ‰€æœ‰ç”¨æˆ·è¾“å…¥
- æ­£ç¡®å¤„ç† ETH å’Œ ERC20 è½¬è´¦
- é¿å…æ•´æ•°æº¢å‡ºï¼ˆSolidity 0.8.x è‡ªåŠ¨æ£€æŸ¥ï¼‰

### ä¸è¦åšçš„äº‹
- âŒ ä¸è¦è·³è¿‡ä»»åŠ¡
- âŒ ä¸è¦åŒæ—¶å¼€å‘å¤šä¸ªä»»åŠ¡
- âŒ ä¸è¦çœç•¥æ³¨é‡Š
- âŒ ä¸è¦æäº¤æœªç¼–è¯‘é€šè¿‡çš„ä»£ç 
- âŒ ä¸è¦å¿½ç•¥éªŒæ”¶åé¦ˆ

---

## ğŸ¤ ä¸é¡¹ç›®ç»ç†çš„åä½œ

### æ¯æ—¥åŒæ­¥
æ¯å¤©ç»“æŸæ—¶ï¼Œç®€å•å‘Šè¯‰é¡¹ç›®ç»ç†è¿›åº¦ï¼š
```
"ä»Šæ—¥è¿›åº¦ï¼š
- å·²å®Œæˆï¼šåˆçº¦ç»“æ„è®¾è®¡ï¼ŒcreateGift å‡½æ•°å®ç°
- è¿›è¡Œä¸­ï¼šclaimGift å‡½æ•°å¼€å‘
- æ˜å¤©è®¡åˆ’ï¼šå®Œæˆ refundGift å’Œæµ‹è¯•
- é‡åˆ°é—®é¢˜ï¼šæ— "
```

### é‡åˆ°é—®é¢˜æ—¶
ç«‹å³åé¦ˆï¼š
```
"é‡åˆ°æŠ€æœ¯é—®é¢˜ï¼š
é—®é¢˜æè¿°ï¼šä¸ç¡®å®šå¦‚ä½•å¤„ç† NFT çš„å®‰å…¨è½¬è´¦
å½“å‰å°è¯•ï¼šæŸ¥çœ‹äº† OpenZeppelin æ–‡æ¡£
éœ€è¦å¸®åŠ©ï¼šæ˜¯å¦æœ‰å‚è€ƒç¤ºä¾‹ï¼Ÿ"
```

### ä»»åŠ¡å®Œæˆæ—¶
è¯¦ç»†è¯´æ˜ï¼š
```
"ZES-XX å·²å®Œæˆï¼Œè¯·éªŒæ”¶ã€‚
ä¸»è¦å®ç°ï¼š...
æµ‹è¯•æƒ…å†µï¼š...
å·²çŸ¥é—®é¢˜ï¼š...ï¼ˆå¦‚æœæœ‰ï¼‰"
```

---

## ğŸ“š å¿«é€Ÿå‚è€ƒ

### é¡¹ç›®ç»“æ„
```
HongBao/
â”œâ”€â”€ packages/contracts/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ HongBaoPacket.sol  â† å‚è€ƒè¿™ä¸ª
â”‚   â”‚   â””â”€â”€ DeGift.sol         â† ä½ è¦åˆ›å»ºçš„
â”‚   â”œâ”€â”€ test/
â”‚   â”‚   â””â”€â”€ DeGift.t.sol       â† åç»­ä¼šåˆ›å»º
â”‚   â””â”€â”€ script/
â”‚       â””â”€â”€ Deploy.s.sol       â† éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ apps/api/                   â† Phase 2 ä¼šç”¨åˆ°
â””â”€â”€ apps/web/                   â† Phase 3 ä¼šç”¨åˆ°
```

### å¸¸ç”¨å‘½ä»¤
```bash
# è¿›å…¥åˆçº¦ç›®å½•
cd /Users/lushengqi/å·¥ä½œé—´/Github/HongBao/packages/contracts

# ç¼–è¯‘åˆçº¦
forge build

# è¿è¡Œæµ‹è¯•ï¼ˆåç»­ä»»åŠ¡ï¼‰
forge test

# æŸ¥çœ‹ gas æŠ¥å‘Š
forge test --gas-report
```

### Linear é“¾æ¥
- **ä¸»ä»»åŠ¡**: https://linear.app/zesty-studio/issue/ZES-68
- **å½“å‰ä»»åŠ¡**: https://linear.app/zesty-studio/issue/ZES-69
- **æ‰€æœ‰ä»»åŠ¡**: https://linear.app/zesty-studio (Filter: parent:ZES-68)

---

## ğŸ¯ å¼€å§‹å§ï¼

ç°åœ¨å°±å¼€å§‹å¼€å‘ ZES-69 ä»»åŠ¡å§ï¼

**ç¬¬ä¸€æ­¥**ï¼šå‘Šè¯‰é¡¹ç›®ç»ç†ä½ å¼€å§‹äº†
**ç¬¬äºŒæ­¥**ï¼šé˜…è¯» HongBaoPacket.sol ç†è§£ç°æœ‰å®ç°
**ç¬¬ä¸‰æ­¥**ï¼šåˆ›å»º DeGift.sol å¹¶å¼€å§‹ç¼–ç 
**ç¬¬å››æ­¥**ï¼šå®Œæˆåæäº¤éªŒæ”¶

ç¥å¼€å‘é¡ºåˆ©ï¼ğŸ’ª

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-11-03
**ä¸‹æ¬¡æ›´æ–°**: ä»»åŠ¡å®Œæˆå
