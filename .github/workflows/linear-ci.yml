name: Linear CI Integration

on:
  # Âú® PR ÂàõÂª∫ÊàñÊõ¥Êñ∞Êó∂ÔºåÊ£ÄÊü•ÊòØÂê¶Êúâ Linear issue ÂÖ≥ËÅî
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: [main, develop]

jobs:
  check-linear-issues:
    name: Check Linear Issues in PR
    runs-on: ubuntu-latest
    if: github.event.pull_request.state == 'open'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract Linear issue IDs from PR
        id: extract_issues
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body || '' }}"
          
          # ÊèêÂèñ Linear issue IDs (Ê†ºÂºè: ZES-123, ENG-456)
          ISSUES=$(echo -e "$PR_TITLE\n$PR_BODY" | grep -oE '[A-Z]+-[0-9]+' | sort -u || true)
          
          if [ -z "$ISSUES" ]; then
            echo "No Linear issues found in PR"
            echo "issues=" >> $GITHUB_OUTPUT
            echo "found=false" >> $GITHUB_OUTPUT
          else
            echo "Found Linear issues: $ISSUES"
            # ËΩ¨Êç¢‰∏∫ÈÄóÂè∑ÂàÜÈöîÁöÑÂ≠óÁ¨¶‰∏≤
            ISSUES_CSV=$(echo "$ISSUES" | tr '\n' ',' | sed 's/,$//')
            echo "issues=$ISSUES_CSV" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with Linear issues
        if: steps.extract_issues.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issuesStr = `${{ steps.extract_issues.outputs.issues }}`;
            const issues = issuesStr.split(',').filter(Boolean);
            if (issues.length > 0) {
              const body = `## üîó Linked Linear Issues\n\n` +
                issues.map(id => `- [${id.trim()}](https://linear.app/zesty-studio/issue/${id.trim()})`).join('\n');
              
              // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèËØÑËÆ∫Ëøá
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              
              const existingComment = comments.data.find(c => 
                c.user.type === 'Bot' && c.body.includes('Linked Linear Issues')
              );
              
              if (existingComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: body
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: body
                });
              }
            }

  update-on-merge:
    name: Update Linear Issues on Merge
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Extract Linear issue IDs
        id: extract_issues
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body || '' }}"
          
          ISSUES=$(echo -e "$PR_TITLE\n$PR_BODY" | grep -oE '[A-Z]+-[0-9]+' | sort -u || true)
          
          if [ -z "$ISSUES" ]; then
            echo "No Linear issues found in PR"
            echo "issues=" >> $GITHUB_OUTPUT
            echo "found=false" >> $GITHUB_OUTPUT
          else
            echo "Found Linear issues: $ISSUES"
            # ËΩ¨Êç¢‰∏∫ÈÄóÂè∑ÂàÜÈöîÁöÑÂ≠óÁ¨¶‰∏≤Áî®‰∫é linear-update.cjs
            ISSUES_CSV=$(echo "$ISSUES" | tr '\n' ',' | sed 's/,$//')
            echo "issues=$ISSUES_CSV" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
          fi

      - name: Update Linear issues to Done
        if: steps.extract_issues.outputs.found == 'true'
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          LINEAR_TEAM_KEY: ${{ secrets.LINEAR_TEAM_KEY || 'ZES' }}
        run: |
          if [ -n "${{ steps.extract_issues.outputs.issues }}" ]; then
            # Â∞ÜÊØè‰∏™ issue ËÆæÁΩÆ‰∏∫ Done Áä∂ÊÄÅ
            # Ê†ºÂºè: ZES-123=Done,ZES-124=Done
            ISSUES="${{ steps.extract_issues.outputs.issues }}"
            UPDATES=$(echo "$ISSUES" | sed 's/,/\\n/g' | sed 's/$/=Done/g' | tr '\n' ',' | sed 's/,$//')
            echo "Updating Linear issues: $UPDATES"
            export LINEAR_UPDATES="$UPDATES"
            node apps/api/scripts/linear-update.cjs
          fi

